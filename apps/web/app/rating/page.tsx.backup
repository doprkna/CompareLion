/**
 * Rating Hub Page
 * Universal Rating Engine - Rate Anything
 * v0.38.7 - Universal Rating Hub
 */

'use client';

import { useState, useEffect, useRef } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Plus } from 'lucide-react';
import { apiFetch } from '@/lib/apiBase';
import { getAllCategories } from '@/lib/rating/presets';
import { PRESETS } from '@/lib/presets/rating';
import { RatingCard } from '@/components/RatingCard';
import { CreateTemplateForm } from '@/components/CreateTemplateForm';

interface RatingHistoryItem {
  id: string;
  category: string;
  createdAt: string;
  hasResult: boolean;
}

interface UserTemplate {
  id: string;
  name: string;
  categoryLabel: string;
  icon?: string;
  isPublic: boolean;
}

export default function RatingHubPage() {
  const [category, setCategory] = useState<string>('snack');
  const [imageUrl, setImageUrl] = useState<string>('');
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [previewUrl, setPreviewUrl] = useState<string | null>(null);
  const [text, setText] = useState<string>('');
  const [requestId, setRequestId] = useState<string | null>(null);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [history, setHistory] = useState<RatingHistoryItem[]>([]);
  const [isLoadingHistory, setIsLoadingHistory] = useState(false);
  const [viewingRequestId, setViewingRequestId] = useState<string | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [categorySuggestions, setCategorySuggestions] = useState<Array<{ name: string; confidence: number }>>([]);
  const [isDetectingCategory, setIsDetectingCategory] = useState(false);
  const [userTemplates, setUserTemplates] = useState<UserTemplate[]>([]);
  const [publicTemplates, setPublicTemplates] = useState<UserTemplate[]>([]);
  const [showCreateTemplate, setShowCreateTemplate] = useState(false);

  useEffect(() => {
    loadHistory();
    loadTemplates();
  }, []);

  const loadTemplates = async () => {
    try {
      // Load public templates
      const publicResponse = await apiFetch('/api/templates/public?limit=20');
      const publicData = await publicResponse.json();
      if (publicData.success) {
        setPublicTemplates(publicData.templates || []);
      }

      // Load own templates
      const ownResponse = await apiFetch('/api/templates/own');
      const ownData = await ownResponse.json();
      if (ownData.success) {
        setUserTemplates(ownData.templates || []);
      }
    } catch (error) {
      // Silently fail - templates are optional
    }
  };

  const loadHistory = async () => {
    setIsLoadingHistory(true);
    try {
      const response = await apiFetch('/api/rating/history?limit=20');
      const data = await response.json();
      if (data.success && data.history) {
        setHistory(data.history);
      }
    } catch (error) {
      // Silently fail - history is optional
    } finally {
      setIsLoadingHistory(false);
    }
  };

  const detectCategory = async (imageUrl: string) => {
    setIsDetectingCategory(true);
    try {
      const response = await apiFetch('/api/rating/detect-category', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ imageUrl }),
      });

      const data = await response.json();
      if (data.success && data.categories && data.final) {
        // Sort by confidence and take top 3
        const topSuggestions = data.categories
          .sort((a: any, b: any) => b.confidence - a.confidence)
          .slice(0, 3);
        setCategorySuggestions(topSuggestions);
        
        // Auto-fill category with top suggestion
        if (data.final && getAllCategories().includes(data.final)) {
          setCategory(data.final);
        }
      }
    } catch (error) {
      // Silently fail - detection is optional
      setCategorySuggestions([]);
    } finally {
      setIsDetectingCategory(false);
    }
  };

  const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // Validate file type
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
      setError('Invalid file type. Please select an image file.');
      return;
    }

    // Validate file size (1 MB)
    if (file.size > 1024 * 1024) {
      setError('File too large. Maximum size is 1 MB.');
      return;
    }

    setSelectedFile(file);
    setError(null);
    setCategorySuggestions([]);

    // Create preview
    const reader = new FileReader();
    reader.onloadend = () => {
      const preview = reader.result as string;
      setPreviewUrl(preview);
      
      // Detect category from preview (data URL)
      detectCategory(preview);
    };
    reader.readAsDataURL(file);
  };

  const handleRemoveFile = () => {
    setSelectedFile(null);
    setPreviewUrl(null);
    setImageUrl('');
    setCategorySuggestions([]);
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!imageUrl && !selectedFile && !text.trim()) {
      setError('Please provide either an image (file or URL) or text description');
      return;
    }

    setIsSubmitting(true);
    setError(null);
    setRequestId(null);
    setViewingRequestId(null);

    try {
      let finalImageUrl = imageUrl;

      // Upload file if selected
      if (selectedFile) {
        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('category', category);

        // Use photo upload endpoint to get image URL
        const uploadResponse = await fetch('/api/challenge/photo/upload', {
          method: 'POST',
          body: formData,
        });

        const uploadData = await uploadResponse.json();
        if (!uploadResponse.ok || !uploadData.success) {
          throw new Error(uploadData.error || 'Failed to upload image');
        }

        finalImageUrl = uploadData.entry?.imageUrl || '';
      }

      // Create rating request
      const response = await apiFetch('/api/rating/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          category,
          imageUrl: finalImageUrl || undefined,
          text: text.trim() || undefined,
        }),
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.error || 'Failed to create rating request');
      }

      setRequestId(data.requestId);
      setViewingRequestId(data.requestId);
      
      // Reload history
      loadHistory();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to submit rating request');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleViewResult = (id: string, cat: string) => {
    setViewingRequestId(id);
    setCategory(cat);
    setRequestId(null); // Clear new request to show history one
  };

  const preset = getCategoryPreset(category);

  return (
    <div className="container mx-auto px-4 py-8 max-w-4xl">
      <div className="mb-8">
        <h1 className="text-3xl font-bold mb-2">Rate Anything</h1>
        <p className="text-gray-600">
          Submit content for AI evaluation and get category-specific scores
        </p>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Rating Form */}
        <div>
          <Card>
            <CardHeader>
              <CardTitle>Get My Rating</CardTitle>
              <CardDescription>
                Submit an image or text description to get AI-rated scores
              </CardDescription>
            </CardHeader>
            <CardContent>
              <form onSubmit={handleSubmit} className="space-y-4">
                {/* Category Select */}
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <Label htmlFor="category">Category</Label>
                    <Button
                      type="button"
                      variant="outline"
                      size="sm"
                      onClick={() => setShowCreateTemplate(true)}
                      className="text-xs"
                    >
                      <Plus className="w-3 h-3 mr-1" />
                      Create Template
                    </Button>
                  </div>
                  <select
                    id="category"
                    value={category}
                    onChange={(e) => setCategory(e.target.value)}
                    className="w-full h-10 px-3 py-2 border border-input bg-background rounded-md text-sm"
                    disabled={isSubmitting}
                  >
                    <optgroup label="Built-in Categories">
                      {getAllCategories().map((cat) => {
                        const catPreset = getCategoryPreset(cat);
                        return (
                          <option key={cat} value={cat}>
                            {catPreset?.name || cat}
                          </option>
                        );
                      })}
                    </optgroup>
                    {userTemplates.length > 0 && (
                      <optgroup label="My Templates">
                        {userTemplates.map((template) => (
                          <option key={template.id} value={`template:${template.id}`}>
                            {template.icon} {template.categoryLabel}
                          </option>
                        ))}
                      </optgroup>
                    )}
                    {publicTemplates.length > 0 && (
                      <optgroup label="Public Templates">
                        {publicTemplates.map((template) => (
                          <option key={template.id} value={`template:${template.id}`}>
                            {template.icon} {template.categoryLabel} {template.isPublic && '(Public)'}
                          </option>
                        ))}
                      </optgroup>
                    )}
                  </select>
                </div>

                {/* File Upload */}
                <div>
                  <Label htmlFor="file">Upload Image (optional)</Label>
                  {!previewUrl ? (
                    <div>
                      <Input
                        id="file"
                        type="file"
                        accept="image/jpeg,image/jpg,image/png,image/webp,image/gif"
                        onChange={handleFileSelect}
                        disabled={isSubmitting}
                        ref={fileInputRef}
                        className="cursor-pointer"
                      />
                    </div>
                  ) : (
                    <div className="space-y-2">
                      <div className="relative w-full aspect-square rounded-lg overflow-hidden bg-gray-100">
                        <img
                          src={previewUrl}
                          alt="Preview"
                          className="w-full h-full object-cover"
                        />
                      </div>
                      <Button
                        type="button"
                        variant="outline"
                        size="sm"
                        onClick={handleRemoveFile}
                        disabled={isSubmitting}
                      >
                        Remove Image
                      </Button>
                    </div>
                  )}
                </div>

                {/* Image URL (alternative) */}
                <div>
                  <Label htmlFor="imageUrl">Or Image URL (optional)</Label>
                  <Input
                    id="imageUrl"
                    type="url"
                    value={imageUrl}
                    onChange={async (e) => {
                      const url = e.target.value;
                      setImageUrl(url);
                      setCategorySuggestions([]);
                      
                      // Detect category when URL is provided
                      if (url && url.startsWith('http')) {
                        detectCategory(url);
                      }
                    }}
                    placeholder="https://example.com/image.jpg"
                    disabled={isSubmitting || !!selectedFile}
                  />
                </div>

                {/* Category Suggestions */}
                {categorySuggestions.length > 0 && (
                  <div className="text-xs space-y-1">
                    <div className="text-gray-600 font-medium">
                      {isDetectingCategory ? 'Detecting category...' : 'AI Suggestions:'}
                    </div>
                    <div className="flex flex-wrap gap-2">
                      {categorySuggestions.map((suggestion) => {
                        const catPreset = PRESETS[suggestion.name as keyof typeof PRESETS];
                        return (
                          <button
                            key={suggestion.name}
                            type="button"
                            onClick={() => setCategory(suggestion.name)}
                            className={`px-2 py-1 rounded text-xs border ${
                              category === suggestion.name
                                ? 'bg-blue-100 border-blue-300 text-blue-900'
                                : 'bg-gray-50 border-gray-200 text-gray-700 hover:bg-gray-100'
                            }`}
                            disabled={isSubmitting}
                          >
                            {catPreset?.name || suggestion.name} ({Math.round(suggestion.confidence * 100)}%)
                          </button>
                        );
                      })}
                    </div>
                  </div>
                )}

                {/* Text */}
                <div>
                  <Label htmlFor="text">Text Description (optional)</Label>
                  <textarea
                    id="text"
                    value={text}
                    onChange={(e) => setText(e.target.value)}
                    placeholder="Describe your content..."
                    className="w-full min-h-[100px] px-3 py-2 border border-input bg-background rounded-md text-sm"
                    disabled={isSubmitting}
                    maxLength={500}
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    {text.length}/500 characters
                  </p>
                </div>

                {/* Error Message */}
                {error && (
                  <div className="text-sm text-red-600 bg-red-50 p-2 rounded">
                    {error}
                  </div>
                )}

                {/* Submit Button */}
                <Button
                  type="submit"
                  disabled={isSubmitting || (!imageUrl && !selectedFile && !text.trim())}
                  className="w-full"
                >
                  {isSubmitting ? 'Submitting...' : 'Get My Rating'}
                </Button>
              </form>
            </CardContent>
          </Card>

          {/* Rating Results */}
          {(requestId || viewingRequestId) && (
            <div className="mt-6">
              <RatingCard
                requestId={viewingRequestId || requestId || ''}
                category={category}
              />
            </div>
          )}
        </div>

        {/* History Section */}
        <div>
          <Card>
            <CardHeader>
              <CardTitle>Recent Ratings</CardTitle>
              <CardDescription>
                Your rating history
              </CardDescription>
            </CardHeader>
            <CardContent>
              {isLoadingHistory ? (
                <div className="text-center py-4 text-gray-500">Loading history...</div>
              ) : history.length === 0 ? (
                <div className="text-center py-4 text-gray-500">
                  No ratings yet. Submit your first rating above!
                </div>
              ) : (
                <div className="space-y-2">
                  {history.map((item) => {
                    const catPreset = item.category.startsWith('template:') ? null : PRESETS[item.category as keyof typeof PRESETS];
                    return (
                      <div
                        key={item.id}
                        className="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50"
                      >
                        <div className="flex-1 min-w-0">
                          <div className="text-sm font-medium capitalize">
                            {catPreset?.name || item.category}
                          </div>
                          <div className="text-xs text-gray-500">
                            {new Date(item.createdAt).toLocaleDateString()}
                          </div>
                        </div>
                        {item.hasResult && (
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => handleViewResult(item.id, item.category)}
                          >
                            View Result
                          </Button>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </CardContent>
          </Card>
        </div>
      </div>

      {/* Create Template Dialog */}
      <Dialog open={showCreateTemplate} onOpenChange={setShowCreateTemplate}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Create Rating Template</DialogTitle>
          </DialogHeader>
          <CreateTemplateForm
            onSuccess={() => {
              setShowCreateTemplate(false);
              loadTemplates();
            }}
            onCancel={() => setShowCreateTemplate(false)}
          />
        </DialogContent>
      </Dialog>
    </div>
  );
}


