/**
 * Story Feed Page
 * Public story stream with reactions and stickers
 * v0.40.6 - Story Reactions + Stickers 1.0
 */

'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Loader2, Heart, Laugh, Sparkles, RefreshCw, Plus, X, Repeat, Volume2, TrendingUp } from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';
import { apiFetch } from '@/lib/apiBase';
import { getAllStickers, type Sticker } from '@parel/story/stickers';

interface StorySticker {
  id: string;
  emoji: string;
  count: number;
}

interface StoryFeedItem {
  id: string;
  userId: string;
  user: {
    id: string;
    name: string | null;
    username: string | null;
  };
  type: string;
  coverImageUrl: string | null;
  exportId: string | null;
  createdAt: string;
  reactions: {
    like: number;
    lol: number;
    vibe: number;
  };
  stickers: StorySticker[];
  remixMetadata?: {
    parentStoryId: string;
    parentAuthor: {
      id: string;
      name: string | null;
      username: string | null;
    };
    remixType: string;
  } | null;
  audioType?: string | null;
  audioTagId?: string | null;
  audioUrl?: string | null;
  rankScore?: number; // v0.40.16 - Ranking score
  viewCount?: number; // v0.40.16 - View count
}

interface StoryFeedResponse {
  success: boolean;
  stories: StoryFeedItem[];
  nextCursor: string | null;
}

const TYPE_LABELS: Record<string, string> = {
  simple: 'Simple',
  extended: 'Extended',
  weekly: 'Weekly',
};

export default function StoryFeedPage() {
  const { data: session, status } = useSession();
  const router = useRouter();
  const [sortMode, setSortMode] = useState<'ranked' | 'latest'>('ranked');
  const [stories, setStories] = useState<StoryFeedItem[]>([]);
  const [loading, setLoading] = useState(true);
  const [nextCursor, setNextCursor] = useState<string | null>(null);
  const [reacting, setReacting] = useState<Set<string>>(new Set());
  const [stickerPanelOpen, setStickerPanelOpen] = useState<string | null>(null);
  const [showAllStickers, setShowAllStickers] = useState<Set<string>>(new Set());

  useEffect(() => {
    if (status === 'unauthenticated') {
      router.push('/login');
      return;
    }
    if (status === 'authenticated') {
      loadFeed();
    }
  }, [status, router, sortMode]);

  async function loadFeed(cursor?: string | null) {
    setLoading(true);
    try {
      const params = new URLSearchParams();
      params.set('limit', '20');
      if (cursor) {
        params.set('cursor', cursor);
      }

      const res = await apiFetch(`/api/story/feed?${params.toString()}`);
      const data = (await res.json()) as StoryFeedResponse;

      if (data.success) {
        if (cursor) {
          setStories((prev) => [...prev, ...data.stories]);
        } else {
          setStories(data.stories);
        }
        setNextCursor(data.nextCursor);
      }
    } catch (error) {
      console.error('Failed to load story feed', error);
    } finally {
      setLoading(false);
    }
  }

  async function handleReaction(storyId: string, type: 'like' | 'lol' | 'vibe') {
    if (reacting.has(storyId)) return;

    setReacting((prev) => new Set(prev).add(storyId));

    // Optimistic update
    const storyIndex = stories.findIndex((s) => s.id === storyId);
    if (storyIndex === -1) return;

    const story = stories[storyIndex];
    const newStories = [...stories];
    const currentCount = story.reactions[type];
    
    // Toggle: if count is 0, assume we're adding, otherwise toggle
    // (We don't track user's own reactions client-side, so this is approximate)
    newStories[storyIndex] = {
      ...story,
      reactions: {
        ...story.reactions,
        [type]: currentCount === 0 ? currentCount + 1 : Math.max(0, currentCount - 1),
      },
    };
    setStories(newStories);

    try {
      const res = await apiFetch('/api/story/react', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          storyId,
          type,
          action: 'toggle',
        }),
      });

      const data = await res.json();
      if (data.success) {
        // Update with server response
        newStories[storyIndex] = {
          ...story,
          reactions: data.reactions,
          stickers: data.stickers || story.stickers,
        };
        setStories(newStories);
      } else {
        // Revert on error
        setStories(stories);
      }
    } catch (error) {
      console.error('Failed to react to story', error);
      // Revert on error
      setStories(stories);
    } finally {
      setReacting((prev) => {
        const next = new Set(prev);
        next.delete(storyId);
        return next;
      });
    }
  }

  async function handleStickerReaction(storyId: string, stickerId: string) {
    if (reacting.has(storyId)) return;

    setReacting((prev) => new Set(prev).add(storyId));
    setStickerPanelOpen(null);

    // Optimistic update
    const storyIndex = stories.findIndex((s) => s.id === storyId);
    if (storyIndex === -1) return;

    const story = stories[storyIndex];
    const newStories = [...stories];
    const stickerIndex = story.stickers.findIndex((s) => s.id === stickerId);
    
    if (stickerIndex >= 0) {
      // Increment existing sticker
      const newStickers = [...story.stickers];
      newStickers[stickerIndex] = {
        ...newStickers[stickerIndex],
        count: newStickers[stickerIndex].count + 1,
      };
      newStories[storyIndex] = {
        ...story,
        stickers: newStickers.sort((a, b) => b.count - a.count),
      };
    } else {
      // Add new sticker
      const sticker = getAllStickers().find((s) => s.id === stickerId);
      if (sticker) {
        const newStickers = [
          ...story.stickers,
          { id: stickerId, emoji: sticker.emoji, count: 1 },
        ].sort((a, b) => b.count - a.count);
        newStories[storyIndex] = {
          ...story,
          stickers: newStickers,
        };
      }
    }
    setStories(newStories);

    try {
      const res = await apiFetch('/api/story/react', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          storyId,
          type: `sticker:${stickerId}`,
          action: 'add',
        }),
      });

      const data = await res.json();
      if (data.success) {
        // Update with server response
        newStories[storyIndex] = {
          ...story,
          reactions: data.reactions,
          stickers: data.stickers || story.stickers,
        };
        setStories(newStories);
      } else {
        // Revert on error
        setStories(stories);
      }
    } catch (error) {
      console.error('Failed to add sticker', error);
      // Revert on error
      setStories(stories);
    } finally {
      setReacting((prev) => {
        const next = new Set(prev);
        next.delete(storyId);
        return next;
      });
    }
  }

  function handleStoryClick(story: StoryFeedItem) {
    // Link to new story viewer (v0.40.11)
    router.push(`/story/view/${story.id}`);
      // Fallback: could navigate to detail page or show modal
      console.log('Story export not available', story.id);
    }
  }

  if (status === 'loading' || loading) {
    return (
      <div className="min-h-screen bg-bg p-4">
        <div className="max-w-4xl mx-auto">
          <div className="flex items-center justify-center py-12">
            <Loader2 className="w-8 h-8 animate-spin text-subtle" />
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-bg p-4">
      <div className="max-w-4xl mx-auto">
        <div className="flex items-center justify-between mb-6">
          <h1 className="text-2xl font-bold text-text">Story Feed</h1>
          <div className="flex gap-2">
            <div className="flex gap-1 border rounded-md p-1">
              <Button
                variant={sortMode === 'ranked' ? 'default' : 'ghost'}
                size="sm"
                onClick={() => {
                  setSortMode('ranked');
                  setCursor(null);
                  setStories([]);
                }}
              >
                Ranked
              </Button>
              <Button
                variant={sortMode === 'latest' ? 'default' : 'ghost'}
                size="sm"
                onClick={() => {
                  setSortMode('latest');
                  setCursor(null);
                  setStories([]);
                }}
              >
                Latest
              </Button>
            </div>
            <Button
              variant="outline"
              size="sm"
              onClick={() => loadFeed()}
              disabled={loading}
            >
              <RefreshCw className={`w-4 h-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
              Refresh
            </Button>
          </div>
        </div>

        {stories.length === 0 && !loading && (
          <Card className="bg-card border-border">
            <CardContent className="p-8 text-center">
              <p className="text-subtle">No stories yet. Be the first to create one!</p>
            </CardContent>
          </Card>
        )}

        <div className="space-y-4">
          {stories.map((story) => (
            <Card
              key={story.id}
              className="bg-card border-border cursor-pointer hover:border-primary/50 transition-colors relative"
              onClick={() => handleStoryClick(story)}
            >
              <CardContent className="p-4">
                <div className="flex gap-4">
                  {story.coverImageUrl && (
                    <div className="flex-shrink-0">
                      <img
                        src={story.coverImageUrl}
                        alt="Story cover"
                        className="w-24 h-24 object-cover rounded-lg"
                      />
                    </div>
                  )}
                  <div className="flex-1 min-w-0 relative">
                    <div className="flex items-center gap-2 mb-2">
                      <span className="font-semibold text-text">
                        {story.user.username || story.user.name || 'Unknown'}
                      </span>
                      <Badge variant="secondary" className="text-xs">
                        {TYPE_LABELS[story.type] || story.type}
                      </Badge>
                      {story.remixMetadata && (
                        <Badge variant="outline" className="text-xs bg-purple-50 text-purple-700">
                          <Repeat className="w-3 h-3 mr-1" />
                          Remix of @{story.remixMetadata.parentAuthor.username || story.remixMetadata.parentAuthor.name || 'user'}
                        </Badge>
                      )}
                      {(story.audioType && story.audioType !== 'none') && (
                        <Badge variant="outline" className="text-xs bg-green-50 text-green-700">
                          <Volume2 className="w-3 h-3 mr-1" />
                          Audio
                        </Badge>
                      )}
                      {story.rankScore !== undefined && story.rankScore > 50 && (() => {
                        const hoursAgo = (Date.now() - new Date(story.createdAt).getTime()) / (1000 * 60 * 60);
                        if (hoursAgo < 48) {
                          return (
                            <Badge variant="outline" className="text-xs bg-orange-50 text-orange-700">
                              <TrendingUp className="w-3 h-3 mr-1" />
                              Trending
                            </Badge>
                          );
                        }
                        return null;
                      })()}
                      <span className="text-xs text-subtle ml-auto">
                        {formatDistanceToNow(new Date(story.createdAt), { addSuffix: true })}
                      </span>
                    </div>

                    {story.remixMetadata && (
                      <div className="mb-2">
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            router.push(`/story/view/${story.remixMetadata!.parentStoryId}`);
                          }}
                          className="text-xs text-purple-600 hover:text-purple-800 underline"
                        >
                          View Original
                        </button>
                      </div>
                    )}

                    <div className="flex items-center gap-4 mt-3 relative">
                      <Button
                        variant="ghost"
                        size="sm"
                        className="h-8 px-2"
                        onClick={(e) => {
                          e.stopPropagation();
                          router.push(`/story/remix/${story.id}`);
                        }}
                        title="Remix this story"
                      >
                        <Repeat className="w-4 h-4" />
                      </Button>
                      <Button
                        variant="ghost"
                        size="sm"
                        className="h-8 px-2"
                        onClick={(e) => {
                          e.stopPropagation();
                          handleReaction(story.id, 'like');
                        }}
                        disabled={reacting.has(story.id)}
                      >
                        <Heart className="w-4 h-4 mr-1" />
                        <span className="text-xs">{story.reactions.like}</span>
                      </Button>
                      <Button
                        variant="ghost"
                        size="sm"
                        className="h-8 px-2"
                        onClick={(e) => {
                          e.stopPropagation();
                          handleReaction(story.id, 'lol');
                        }}
                        disabled={reacting.has(story.id)}
                      >
                        <Laugh className="w-4 h-4 mr-1" />
                        <span className="text-xs">{story.reactions.lol}</span>
                      </Button>
                      <Button
                        variant="ghost"
                        size="sm"
                        className="h-8 px-2"
                        onClick={(e) => {
                          e.stopPropagation();
                          handleReaction(story.id, 'vibe');
                        }}
                        disabled={reacting.has(story.id)}
                      >
                        <Sparkles className="w-4 h-4 mr-1" />
                        <span className="text-xs">{story.reactions.vibe}</span>
                      </Button>
                      <div className="relative">
                        <Button
                          variant="ghost"
                          size="sm"
                          className="h-8 px-2"
                          onClick={(e) => {
                            e.stopPropagation();
                            setStickerPanelOpen(stickerPanelOpen === story.id ? null : story.id);
                          }}
                          disabled={reacting.has(story.id)}
                        >
                          <Plus className="w-4 h-4 mr-1" />
                          <span className="text-xs">Sticker</span>
                        </Button>

                        {/* Sticker Panel Popup */}
                        {stickerPanelOpen === story.id && (
                          <div
                            className="absolute top-full left-0 z-20 mt-2 p-3 bg-card border border-border rounded-lg shadow-lg"
                            onClick={(e) => e.stopPropagation()}
                          >
                            <div className="flex items-center justify-between mb-2">
                              <span className="text-sm font-semibold text-text">Choose Sticker</span>
                              <Button
                                variant="ghost"
                                size="sm"
                                className="h-6 w-6 p-0"
                                onClick={() => setStickerPanelOpen(null)}
                              >
                                <X className="w-4 h-4" />
                              </Button>
                            </div>
                            <div className="grid grid-cols-3 gap-2">
                              {getAllStickers().map((sticker) => (
                                <Button
                                  key={sticker.id}
                                  variant="outline"
                                  size="sm"
                                  className="h-10 w-10 p-0 text-lg"
                                  onClick={() => handleStickerReaction(story.id, sticker.id)}
                                  disabled={reacting.has(story.id)}
                                >
                                  {sticker.emoji}
                                </Button>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Sticker Summary */}
                    {story.stickers.length > 0 && (
                      <div className="mt-2 pt-2 border-t border-border">
                        <div className="flex items-center gap-2 flex-wrap">
                          {(showAllStickers.has(story.id)
                            ? story.stickers
                            : story.stickers.slice(0, 3)
                          ).map((sticker) => (
                            <Badge
                              key={sticker.id}
                              variant="outline"
                              className="text-xs"
                            >
                              <span className="mr-1">{sticker.emoji}</span>
                              <span>{sticker.count}</span>
                            </Badge>
                          ))}
                          {story.stickers.length > 3 && !showAllStickers.has(story.id) && (
                            <Button
                              variant="ghost"
                              size="sm"
                              className="h-6 px-2 text-xs"
                              onClick={(e) => {
                                e.stopPropagation();
                                setShowAllStickers((prev) => new Set(prev).add(story.id));
                              }}
                            >
                              +{story.stickers.length - 3} more
                            </Button>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>

        {nextCursor && (
          <div className="mt-6 text-center">
            <Button
              variant="outline"
              onClick={() => loadFeed(nextCursor)}
              disabled={loading}
            >
              {loading ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Loading...
                </>
              ) : (
                'Load More'
              )}
            </Button>
          </div>
        )}
      </div>
    </div>
  );
}


