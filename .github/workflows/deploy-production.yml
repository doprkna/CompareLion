name: Deploy to Production

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Generate Prisma Client
        run: pnpm -F @parel/db prisma generate
      
      - name: Run tests
        run: pnpm -F @parel/web test:ci
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
      
      - name: Check coverage
        run: |
          COVERAGE=$(jq '.total.lines.pct' apps/web/coverage/coverage-summary.json)
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "âŒ Coverage below 80%, blocking production deploy"
            exit 1
          fi
      
      - name: Run database migrations
        run: pnpm -F @parel/db prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
      
      - name: Build application
        run: pnpm -F @parel/web build
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.PRODUCTION_NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.PRODUCTION_URL }}
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
      
      - name: Deploy to Vercel (Production)
        uses: amondnet/vercel-action@v25
        id: deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: apps/web
        env:
          VERCEL_ENV: production
      
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            ## PareL v${{ steps.version.outputs.VERSION }}
            
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/apps/web/CHANGELOG.md) for details.
            
            ðŸš€ Deployed to production
          draft: false
          prerelease: false
      
      - name: Send deployment success notification
        if: success()
        run: |
          curl -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âœ… Production Deployment Success",
                "description": "PareL v${{ steps.version.outputs.VERSION }} deployed to production",
                "color": 5763719,
                "fields": [
                  {"name": "Version", "value": "v${{ steps.version.outputs.VERSION }}", "inline": true},
                  {"name": "Commit", "value": "${{ github.sha }}", "inline": true},
                  {"name": "URL", "value": "https://parel.app", "inline": false},
                  {"name": "Deployed By", "value": "${{ github.actor }}", "inline": true}
                ],
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'
      
      - name: Send deployment failure notification
        if: failure()
        run: |
          curl -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âŒ Production Deployment Failed",
                "description": "PareL v${{ steps.version.outputs.VERSION }} deployment failed",
                "color": 15158332,
                "fields": [
                  {"name": "Version", "value": "v${{ steps.version.outputs.VERSION }}", "inline": true},
                  {"name": "Commit", "value": "${{ github.sha }}", "inline": true},
                  {"name": "Workflow", "value": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}", "inline": false}
                ],
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'










