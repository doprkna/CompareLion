generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows"]
  engineType    = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator zod {
  provider = "zod-prisma-types"
  output = "./generated"
  useDecimalJs = false
  prismaJsonNullability = true
  createInputTypes = false
  createModelTypes = true
}


model User {
  id                  String         @id @default(cuid())
  email               String         @unique
  passwordHash        String?
  name                String?
  phone               String?
  language            String?
  country             String?
  dateOfBirth         DateTime?
  avatarUrl           String?
  username            String?        @unique
  bio                 String?
  statusMessage   String?  // short bio or vibe
  karma           Int      @default(0)
  avatarFrameId   String?
  isPublicProfile Boolean  @default(true)
  visibility          UserVisibility @default(FRIENDS)
  banned              Boolean        @default(false)
  motto               String?
  theme               String?        @default("light")
  funds               Decimal        @default(0)
  diamonds            Int            @default(0)
  xp                  Int            @default(0)
  level               Int            @default(1)
  lastLoginAt         DateTime?
  lastActiveAt        DateTime?
  createdAt           DateTime       @default(now())
  image               String?
  streakCount         Int            @default(0)
  lastAnsweredAt      DateTime?
  score               Int            @default(0)
  questionsAnswered   Int            @default(0)
  questionsCreated    Int            @default(0)
  emailVerified       DateTime?
  emailVerifiedAt     DateTime?
  newsletterOptIn     Boolean        @default(false)
  role                UserRole       @default(USER)
  archetype String?        @default("Adventurer")
  archetypeKey        String? // v0.26.6 - Archetype system key (warrior, thinker, etc.)
  stats               Json? // v0.26.6 - Character stats { str, int, cha, luck, etc. }
  lastArchetypeReroll DateTime? // v0.26.6 - Cooldown for archetype reroll
  settings            Json? // v0.28.27 - User settings { roastLevel: 1-5, etc. }

  // Localization (v0.27.0 - Phase M)
  lang       Lang   @default(en)
  // Locale code (v0.27.1 - Phase M+): e.g. en-US, cs-CZ
  localeCode String @default("en-US")

  // Onboarding fields (v0.24.0 - Phase I)
  ageGroup            String? // "kid", "teen", "youngAdult", "adult", "mature", "senior"
  region              String? // e.g. "EU-CZ", "US", "GLOBAL"
  interests           String[] @default([]) // e.g. ["food", "psychology", "memes"]
  tone                String? // "funny", "deep", "random", "roast"
  onboardingCompleted Boolean  @default(false)

  // Combat stats (v0.25.0 - Phase J-Lite)
  combatKills         Int @default(0)
  combatBattles       Int @default(0)
  combatHighestStreak Int @default(0)

  statCreativity          Int                            @default(0)
  statHealth              Int                            @default(0)
  statKnowledge           Int                            @default(0)
  statSleep               Int                            @default(0)
  statSocial              Int                            @default(0)
  allowPublicCompare      Boolean                        @default(true)
  canBeAdded              String                         @default("anyone")
  badgeType String?                        @default("none")
  karmaScore              Int                            @default(0)
  prestigeScore           Int                            @default(0)
  showBadges              Boolean                        @default(true)
  coins                   Int                            @default(0)
  seasonalXP              Int                            @default(0)
  seasonLevel             Int                            @default(1) // v0.29.9 - Meta-progression season level
  seasonXP                Int                            @default(0) // v0.29.9 - Meta-progression season XP
  prestigeCount           Int                            @default(0) // v0.29.9 - Total prestige count
  legacyPerk              String? // v0.29.9 - Legacy perk identifier
  prestigeTitle           String? // v0.29.14 - Current prestige title
  prestigeBadgeId         String? // v0.29.14 - Current prestige badge ID
  prestigeColorTheme      String? // v0.29.14 - Current prestige color theme
  currentGeneration       Int                            @default(1) // v0.29.17 - Current generation number
  avatarTheme             String?
  moodFeed                String?
  equippedTitle           String?
  equippedIcon            String?
  equippedBackground      String?
  emailVerifies           EmailVerify[]
  entitlements            Entitlement[]
  passwordResets          PasswordReset[]
  purchases               Purchase[]
  subscriptions           Subscription[]
  userBadges              UserBadge[]
  userGroups              UserGroup[]
  userProfile             UserProfile?
  userQuestions           UserQuestion[]
  wallet                  Wallet?
  accounts                Account[]
  actionLogs              ActionLog[]
  activities              Activity[]
  auditLogs               AuditLog[]
  betaInvitesCreated      BetaInvite[]                   @relation("BetaInvitesCreated")
  betaUser                BetaUser?
  blocksReceived          BlockedUser[]                  @relation("BlocksReceived")
  blocksCreated           BlockedUser[]                  @relation("BlocksCreated")
  challengesInitiated     Challenge[]                    @relation("ChallengeInitiator")
  challengesReceived      Challenge[]                    @relation("ChallengeReceiver")
  clan                    ClanMember?
  coopMemberships         CoopMember[]
  craftingLogs            CraftingLog[]
  followingCreators       CreatorFollower[]              @relation("UserFollowing")
  creatorProfile          CreatorProfile?
  creatorWallet           CreatorWallet?
  dailyQuizCompletions    DailyQuizCompletion[]
  dailySummaries          DailySummary[]
  spectatedDuels          DuelSpectator[]
  duelsInitiated          Duel[]                         @relation("DuelInitiator")
  duelsReceived           Duel[]                         @relation("DuelReceiver")
  creatorEngagements      EngagementMetric[]             @relation("CreatorEngagements")
  userEngagements         EngagementMetric[]             @relation("UserEngagements")
  eventLogs               EventLog[]                     @relation("EventLogs")
  factionChanges          FactionChangeLog[]
  factionMembership       FactionMember?
  factionVotes            FactionVote[]
  feedbackMoods           FeedbackMood[]
  feedbackSubmissions     FeedbackSubmission[]
  friendOf                Friend[]                       @relation("FriendOf")
  friends                 Friend[]                       @relation("UserFriends")
  feedItems               GlobalFeedItem[]
  groupMemberships        GroupMember[]
  affinitiesFrom          Affinity[]                     @relation("FromUser")
  affinitiesTo            Affinity[]                     @relation("ToUser")
  inventoryItems  InventoryItem[]
  userItems       UserItem[]
  languagePreference      LanguagePreference?
  legacyRecords           LegacyRecord[]
  marketListings          MarketListing[]                @relation("seller")
  marketPurchases         MarketListing[]                @relation("buyer") // v0.26.4
  memberships             Membership[]
  mentorLogs              MentorLog[]
  mentorProfile           MentorProfile?
  receivedMessages        Message[]                      @relation("ReceivedMessages")
  sentMessages            Message[]                      @relation("SentMessages")
  miniEventProgress       MiniEventProgress[]
  moderationPerformed     ModerationAction[]             @relation("ModerationActionsPerformed")
  moderationActions       ModerationAction[]
  narrativeQuests         NarrativeQuest[]
  userPets              UserPet[]        @relation("UserPets")
  userSkills            UserSkill[]        @relation("UserSkills")
  notifications           Notification[]
  npcInteractions         NpcInteraction[]
  offlineActions          OfflineAction[]
  onboardingProgress      OnboardingProgress?
  paymentLogs             PaymentLog[]
  playerQuotes            PlayerQuote[]
  presence                Presence?
  ownedThemes             ProfileTheme[]
  pushSubscriptions       PushSubscription[]
  questCompletions        QuestCompletion[]
  reactions               Reaction[]
  referralsReceived       Referral?                      @relation("ReferralsReceived")
  referralsSent           Referral[]                     @relation("ReferralsSent")
  reflectionEntries       ReflectionEntry[]
  reportsReceived         Report[]                       @relation("ReportsReceived")
  reportsSubmitted        Report[]                       @relation("ReportsSubmitted")
  reportsResolved         Report[]                       @relation("ReportsResolved")
  reputationScore         ReputationScore?
  returnBonuses           ReturnBonus[]
  rewardCalendars         RewardCalendar[]
  rewardRedemptions       RewardRedemption[]
  sessions                Session[]
  createdTasks            Task[]                         @relation("TaskCreator")
  taxTransactions         TaxTransaction[]
  threatBattles           ThreatBattle[]
  combatSessions          CombatSession[]
  fights      Fight[]
  completedCollections    UserAchievementCollection[]
  userAchievements        UserAchievement[]
  archetypeHistory        UserArchetypeHistory[]
  ownedAvatarItems        UserAvatarItem[]
  avatar                  UserAvatar?
  energy                  UserEnergy?
  insights                UserInsight[]
  legacyBonuses           UserLegacyBonus[]
  userPreferences         UserPreferences?
  flowResponses           UserResponse[]
  userSynchTestsA         UserSynchTest[]                @relation("UserSynchTestsA")
  userSynchTestsB         UserSynchTest[]                @relation("UserSynchTestsB")
  userStreak              UserStreak?
  premiumSubscriptions    UserSubscription[]
  themeSettings           UserThemeSettings?
  userTimeZone            UserTimeZone?
  weeklyParticipations    WeeklyChallengeParticipation[]
  userSubmissions         UserSubmission[]               @relation("UserSubmissions")
  moderatedSubmissions    UserSubmission[]               @relation("ModeratedSubmissions")
  createdEvents           Event[]                        @relation("CreatedEvents")
  votes                   Vote[]                         @relation("UserVotes")
  cosmetics               UserCosmetic[]
  seasonArchives          SeasonArchive[]
  reflections             UserReflection[]
  chronicles              Chronicle[]
  reflectionConversations ReflectionConversation[] // v0.29.2 - AI conversations
  userRegions             UserRegion[] // v0.29.3 - World regions
  userQuests              UserQuest[] // v0.29.4 - Quest tracking
  loreEntries             UserLoreEntry[] // v0.29.5 - Personal lore log
  friendshipsAsA          Friendship[]                   @relation("UserA") // v0.29.7 - Social friendships
  friendshipsAsB          Friendship[]                   @relation("UserB") // v0.29.7 - Social friendships
  duelsAsChallenger       SocialDuel[]                   @relation("Challenger") // v0.29.7 - Social duels
  duelsAsOpponent         SocialDuel[]                   @relation("Opponent") // v0.29.7 - Social duels
  duelsAsWinner           SocialDuel[]                   @relation("Winner") // v0.29.7 - Social duels
  userWallets             UserWallet[] // v0.29.8 - Multi-currency wallets
  transactions            Transaction[] // v0.29.8 - Transaction history
  prestigeRecords         PrestigeRecord[] // v0.29.9 - Prestige progression
  userWildcardEvents      UserWildcardEvent[] // v0.29.13 - Wildcard Events
  shareCards              ShareCard[] // v0.29.15 - Share Cards
  userDreamEvents         UserDreamEvent[] // v0.29.16 - Dreamspace Events
  generationRecords       GenerationRecord[] // v0.29.17 - Generation Records
  feedback                Feedback[] // v0.29.19 - Feedback
  creatorPacks            CreatorPack[] // v0.29.19 - Creator Packs
  itemDiscoveries         ItemDiscovery[] // v0.29.20 - Item Discoveries
  reflectionJournals      Reflection[]
  pollResponses           PollResponse[]
  userArchetypeFusions    UserArchetypeFusion[]
  userPacks               UserPack[]
  memoryJournals          MemoryJournal[]
  comparisonCards         ComparisonCard[]
  userMicroMissions       UserMicroMission[]
  avatarMoods             AvatarMood[]
  userMentors             UserMentor[]
  faction                 UserFaction?
  communityCreations      CommunityCreation[]
  communityCreationLikes  CommunityCreationLike[]
  sentPostcards           Postcard[]                     @relation("SentPostcards")
  receivedPostcards       Postcard[]                     @relation("ReceivedPostcards")
  dailyForks              UserDailyFork[]
  duetRunsA               UserDuetRun[]                  @relation("DuetRunsUserA")
  duetRunsB               UserDuetRun[]                  @relation("DuetRunsUserB")
  rituals                 UserRitual[]
  microClansLed           MicroClan[]                    @relation("MicroClanLeader")
  lootMoments             UserLootMoment[]
  userStats               UserStats? // v0.29.22 - Unified stats (replaces weekly_stats)
  weeklyStats             UserWeeklyStats[] // v0.29.22 - Deprecated, kept for backward compatibility
  sentNotifications       Notification[]                 @relation("SentNotifications")
   comments                Comment[]                      @relation("UserComments")
   moderationLogs          ModerationLog[]                @relation("ModeratorLogs")
   battleAchievements      UserBattleAchievement[]        // v0.29.25 - Battle achievements
   moodLogs                 UserMoodLog[]                  // v0.29.26 - Mood logs
   userCreatedPacks         UserCreatedPack[]              // v0.29.27 - User created packs
   posterCards               PosterCard[]                   // v0.29.28 - Poster cards
   npcAffinities             NpcAffinity[]                 // v0.29.29 - NPC affinity tracking

   @@index([emailVerifiedAt])
  @@index([role])
  @@index([username])
  feedPosts      FeedPost[]
  feedComments   FeedComment[]
  feedReactions  FeedReaction[]
  comparePosts     ComparePost[]        @relation("ComparePosts")
  compareReactions CompareReaction[]   @relation("CompareReactions")
  compareComments  CompareComment[]    @relation("CompareComments")

  @@map("users")
}

model Affinity {
  id         String   @id @default(cuid())
  sourceId   String
  targetId   String
  type String?
  strength   Float    @default(0.5)
  mutual     Boolean  @default(false)
  visibility String   @default("public")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  source     User     @relation("FromUser", fields: [sourceId], references: [id], onDelete: Cascade)
  target     User     @relation("ToUser", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([sourceId, targetId, type])
  @@index([type, mutual])
  @@map("affinities")
}

model Org {
  id           String        @id @default(cuid())
  name         String
  createdAt    DateTime      @default(now())
  integrations Integration[]
  memberships  Membership[]
  tasks        Task[]
  workflows    Workflow[]

  @@map("orgs")
}

model Membership {
  id     String @id @default(cuid())
  userId String
  orgId  String
  role   String @default("MEMBER")
  org    Org    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
  @@map("memberships")
}

model Task {
  id           String        @id @default(cuid())
  orgId        String
  createdById  String
  title        String
  description String?
  region          String?
  status       TaskStatus    @default(NEW)
  priority     String        @default("MEDIUM")
  source       TaskSource    @default(WEB)
  assigneeType AssigneeType  @default(AUTO)
  assigneeId   String?
  dueAt        DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  attachments  Attachment[]
  runs         Run[]
  messages     TaskMessage[]
  creator      User          @relation("TaskCreator", fields: [createdById], references: [id])
  org          Org           @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("tasks")
}

model Attachment {
  id       String @id @default(cuid())
  taskId   String
  name     String
  url      String
  mimeType String?
  size     Int
  task     Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("attachments")
}

model TaskMessage {
  id         String     @id @default(cuid())
  taskId     String
  authorType AuthorType
  text       String
  createdAt  DateTime   @default(now())
  task       Task       @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("task_messages")
}

model Workflow {
  id        String          @id @default(cuid())
  orgId     String
  name      String
  trigger   WorkflowTrigger
  action    WorkflowAction
  keywords  String[]
  isActive  Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  runs      Run[]
  org       Org             @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("workflows")
}

model Run {
  id         String    @id @default(cuid())
  taskId     String
  workflowId String?
  status     RunStatus @default(QUEUED)
  logs       Json?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  task       Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  workflow   Workflow? @relation(fields: [workflowId], references: [id])

  @@map("runs")
}

model Integration {
  id        String          @id @default(cuid())
  orgId     String
  type      IntegrationType
  config    Json
  isActive  Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  org       Org             @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("integrations")
}

model Question {
  text              String
  normalizedText    String?
  difficulty        String?
  source            QuestionSource     @default(ai)
  approved          Boolean            @default(false)
  reviewNotes       String?
  createdByUserId   String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  id                String             @id @default(cuid())
  categoryId        String
  subCategoryId     String?
  subSubCategoryId  String?
  relatedToId       String?
  metadata          Json?
  currentVersionId  String?            @unique
  ssscId            String
  // Localization (v0.27.0 - Phase M)
  lang              Lang?
  region            String?            @default("global")
  isLocalized       Boolean            @default(false)
  // Locale code (v0.27.1)
  localeCode        String?            @default("global")
  // Moderation (v0.27.6)
  isFlagged         Boolean            @default(false)
  flagReason        String?
  visibility        ContentVisibility  @default(PUBLIC)
  // Reactions (v0.27.3)
  reactionsLike     Int                @default(0)
  reactionsLaugh    Int                @default(0)
  reactionsThink    Int                @default(0)
  userQuestions     UserQuestion[]
  versions          QuestionVersion[]  @relation("AllVersions")
  currentVersion    QuestionVersion?   @relation("CurrentVersion", fields: [currentVersionId], references: [id])
  relatedTo         Question?          @relation("RelatedTo", fields: [relatedToId], references: [id])
  relatedQuestions  Question[]         @relation("RelatedTo")
  sssc              SssCategory        @relation("SsscQuestions", fields: [ssscId], references: [id])
  trendingQuestions TrendingQuestion[]

  @@index([ssscId, approved])
  @@index([lang, region])
  @@index([localeCode])
  @@index([visibility])
  @@index([region, createdAt(sort: Desc)])
  @@map("questions")
}

model QuestionVersion {
  id          String               @id @default(cuid())
  questionId  String
  text        String
  displayText String
  type String?
  options     Json?
  metadata    Json?
  createdAt   DateTime             @default(now())
  version     Int
  answers     Answer[]
  flowSteps   FlowStep[]
  tags        QuestionVersionTag[]
  question    Question             @relation("AllVersions", fields: [questionId], references: [id])
  currentOf   Question?            @relation("CurrentVersion")

  @@unique([questionId, version])
  @@map("question_versions")
}

model QuestionTag {
  id          String               @id @default(cuid())
  name        String               @unique
  type        TagType              @default(tone)
  description String?
  region          String?
  versions    QuestionVersionTag[]

  @@map("question_tags")
}

model QuestionVersionTag {
  id                String          @id @default(cuid())
  questionVersionId String
  tagId             String
  questionVersion   QuestionVersion @relation(fields: [questionVersionId], references: [id])
  tag               QuestionTag     @relation(fields: [tagId], references: [id])

  @@unique([questionVersionId, tagId])
  @@index([tagId])
  @@index([questionVersionId])
  @@map("question_version_tags")
}

model QuestionGeneration {
  id            String      @id
  ssscId        String
  targetCount   Int         @default(10)
  status        String      @default("pending")
  prompt        String?     @db.Text
  insertedCount Int         @default(0)
  rawResponse   String?     @db.Text
  finishedAt    DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  sssc          SssCategory @relation("QuestionGenerationLogs", fields: [ssscId], references: [id])

  @@index([ssscId])
  @@index([status])
  @@index([createdAt])
  @@map("question_generations")
}

model FlowQuestion {
  id         String               @id @default(cuid())
  categoryId String?
  locale     String               @default("en")
  text       String
  type       QuestionType         @default(SINGLE_CHOICE)
  isActive   Boolean              @default(true)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
  options    FlowQuestionOption[]
  category   SssCategory?         @relation("FlowQuestions", fields: [categoryId], references: [id])
  responses  UserResponse[]

  @@index([categoryId, isActive])
  @@index([locale, isActive])
  @@map("flow_questions")
}

model FlowQuestionOption {
  id         String       @id @default(cuid())
  questionId String
  label      String
  value      String
  order      Int          @default(0)
  question   FlowQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@map("flow_question_options")
}

model UserResponse {
  id         String       @id @default(cuid())
  userId     String
  questionId String
  optionIds  String[]     @default([]) // for single or multi-select
  numericVal Float? // for range/number
  textVal    String? // for open/free text
  skipped    Boolean      @default(false)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  question   FlowQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@index([userId])
  @@index([questionId])
  @@map("user_responses")
}

// Synch Tests (v0.28.16)
model SynchTest {
  id                  String          @id @default(cuid())
  key                 String          @unique
  title               String
  description String?
  region          String?
  questions           Json // Array of questions
  resultTextTemplates Json // Array of templates based on score ranges
  rewardXP            Int             @default(0)
  rewardKarma         Int             @default(0)
  isActive            Boolean         @default(true)
  createdAt           DateTime        @default(now())
  userSynchTests      UserSynchTest[]

  @@index([isActive])
  @@map("synch_tests")
}

model UserSynchTest {
  id                 String              @id @default(cuid())
  testId             String
  userA              String
  userB              String
  answersA           Json                @default("[]")
  answersB           Json                @default("[]")
  compatibilityScore Float?
  shared             Boolean             @default(false)
  status             UserSynchTestStatus @default(pending)
  createdAt          DateTime            @default(now())
  test               SynchTest           @relation(fields: [testId], references: [id], onDelete: Cascade)
  userA_ref          User                @relation("UserSynchTestsA", fields: [userA], references: [id], onDelete: Cascade)
  userB_ref          User                @relation("UserSynchTestsB", fields: [userB], references: [id], onDelete: Cascade)

  @@index([userA, status])
  @@index([userB, status])
  @@index([testId])
  @@map("user_synch_tests")
}

// Factions (v0.28.17)
model Faction {
  id             String             @id @default(cuid())
  key            String             @unique
  name           String
  motto          String?
  description String?
  region          String?
  colorPrimary   String
  colorSecondary String?
  buffType       FactionBuffType?
  buffValue      Float              @default(1.05)
  regionScope    RegionScope        @default(global)
  isActive       Boolean            @default(true)
  createdAt      DateTime           @default(now())
  influences     FactionInfluence[]
  members        UserFaction[]

  @@index([isActive])
  @@map("factions")
}

model FactionInfluence {
  id                 String   @id @default(cuid())
  factionId          String
  region             String
  influenceScore     Float    @default(0)
  lastUpdated        DateTime @default(now())
  dailyDelta         Float    @default(0)
  contributionsCount Int      @default(0)
  faction            Faction  @relation(fields: [factionId], references: [id], onDelete: Cascade)

  @@unique([region, factionId])
  @@index([region, factionId])
  @@map("faction_influence")
}

model UserFaction {
  userId        String   @id
  factionId     String
  joinedAt      DateTime @default(now())
  contributedXP Int      @default(0)
  isLeader      Boolean  @default(false)
  faction       Faction  @relation(fields: [factionId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([factionId])
  @@map("user_factions")
}

// Community Creations (v0.28.18)
model CommunityCreation {
  id          String                  @id @default(cuid())
  userId      String
  title       String
  type        CreationType
  content     Json // JSON or text content
  status      CreationStatus          @default(pending)
  likes       Int                     @default(0)
  rewardXP    Int?
  rewardKarma Int?
  createdAt   DateTime                @default(now())
  user        User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes_rel   CommunityCreationLike[]

  @@index([status])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("community_creations")
}

model CommunityCreationLike {
  id         String            @id @default(cuid())
  userId     String
  creationId String
  createdAt  DateTime          @default(now())
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  creation   CommunityCreation @relation(fields: [creationId], references: [id], onDelete: Cascade)

  @@unique([userId, creationId])
  @@index([creationId])
  @@map("community_creation_likes")
}

// Postcards (v0.28.19)
model Postcard {
  id         String         @id @default(cuid())
  senderId   String
  receiverId String
  message    String         @db.VarChar(300)
  status     PostcardStatus @default(pending)
  deliveryAt DateTime
  createdAt  DateTime       @default(now())
  sender     User           @relation("SentPostcards", fields: [senderId], references: [id], onDelete: Cascade)
  receiver   User           @relation("ReceivedPostcards", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([receiverId, status])
  @@index([senderId, createdAt(sort: Desc)])
  @@index([status, deliveryAt])
  @@map("postcards")
}

// Rarity Tiers (v0.28.21)
model RarityTier {
  id           String         @id @default(cuid())
  key          String         @unique
  name         String
  colorPrimary String
  colorGlow    String?
  frameStyle   String?
  rankOrder    Int // 1-7
  description String?
  region          String?
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  items        Item[]
  badges       Badge[]
  cosmetics    CosmeticItem[]
  themes       ProfileTheme[]

  @@index([rankOrder])
  @@index([isActive])
  @@map("rarity_tiers")
}

// Daily Forks (v0.28.22)
model DailyFork {
  id          String          @id @default(cuid())
  key         String          @unique
  title       String
  description String?
  region          String?
  optionA     String
  optionB     String
  effectA     Json // JSON effect data
  effectB     Json // JSON effect data
  rarity      ForkRarity      @default(common)
  createdAt   DateTime        @default(now())
  isActive    Boolean         @default(true)
  userForks   UserDailyFork[]

  @@index([isActive])
  @@index([rarity])
  @@index([createdAt(sort: Desc)])
  @@map("daily_forks")
}

model UserDailyFork {
  id            String     @id @default(cuid())
  userId        String
  forkId        String
  choice        ForkChoice
  resultSummary String?
  createdAt     DateTime   @default(now())
  fork          DailyFork  @relation(fields: [forkId], references: [id], onDelete: Cascade)
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, forkId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([forkId])
  @@map("user_daily_forks")
}

// Duet Runs (v0.28.23)
model DuetRun {
  id          String        @id @default(cuid())
  missionKey  String        @unique
  title       String
  description String
  type        DuetRunType
  durationSec Int           @default(300) // 5 min default
  rewardXP    Int           @default(50)
  rewardKarma Int           @default(10)
  createdAt   DateTime      @default(now())
  isActive    Boolean       @default(true)
  userRuns    UserDuetRun[]

  @@index([isActive])
  @@index([type])
  @@index([createdAt(sort: Desc)])
  @@map("duet_runs")
}

model UserDuetRun {
  id        String        @id @default(cuid())
  runId     String
  userA     String
  userB     String
  status    DuetRunStatus @default(pending)
  startedAt DateTime      @default(now())
  endedAt   DateTime?
  progressA Int           @default(0) // 0-100
  progressB Int           @default(0) // 0-100
  run       DuetRun       @relation(fields: [runId], references: [id], onDelete: Cascade)
  userA_ref User          @relation("DuetRunsUserA", fields: [userA], references: [id], onDelete: Cascade)
  userB_ref User          @relation("DuetRunsUserB", fields: [userB], references: [id], onDelete: Cascade)

  @@index([userA, status])
  @@index([userB, status])
  @@index([runId, status])
  @@index([startedAt])
  @@map("user_duet_runs")
}

// Rituals (v0.28.24)
model Ritual {
  id          String          @id @default(cuid())
  key         String          @unique
  title       String
  description String
  rewardXP    Int             @default(10)
  rewardKarma Int             @default(5)
  timeOfDay   RitualTimeOfDay @default(any)
  createdAt   DateTime        @default(now())
  isActive    Boolean         @default(true)
  userRituals UserRitual[]

  @@index([isActive])
  @@index([timeOfDay])
  @@index([createdAt(sort: Desc)])
  @@map("rituals")
}

model UserRitual {
  id             String    @id @default(cuid())
  userId         String
  ritualId       String
  lastCompleted  DateTime?
  streakCount    Int       @default(0)
  totalCompleted Int       @default(0)
  ritual         Ritual    @relation(fields: [ritualId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, ritualId])
  @@index([userId])
  @@index([ritualId])
  @@index([lastCompleted])
  @@map("user_rituals")
}

// Micro-Clans (v0.28.26)
model MicroClan {
  id          String            @id @default(cuid())
  name        String
  description String?
  region          String?
  leaderId    String
  memberIds   String[] // Array of member user IDs (max 5)
  buffType    MicroClanBuffType
  buffValue   Float             @default(1.05)
  seasonId    String?
  createdAt   DateTime          @default(now())
  isActive    Boolean           @default(true)
  stats       MicroClanStats?
  leader      User              @relation("MicroClanLeader", fields: [leaderId], references: [id], onDelete: Cascade)

  @@index([leaderId])
  @@index([seasonId])
  @@index([isActive])
  @@index([createdAt(sort: Desc)])
  @@map("micro_clans")
}

model MicroClanStats {
  id            String    @id @default(cuid())
  clanId        String    @unique
  xpTotal       Int       @default(0)
  activityScore Int       @default(0)
  rank          Int       @default(9999)
  updatedAt     DateTime  @updatedAt
  clan          MicroClan @relation(fields: [clanId], references: [id], onDelete: Cascade)

  @@index([rank])
  @@index([xpTotal(sort: Desc)])
  @@index([activityScore(sort: Desc)])
  @@map("micro_clan_stats")
}

// Loot Moments (v0.28.28)
model LootMoment {
  id          String           @id @default(cuid())
  key         String           @unique
  trigger     LootTrigger
  rewardType  LootRewardType
  rewardValue Int // Value or item ID reference
  rarity      LootRarity       @default(common)
  flavorText  String?
  createdAt   DateTime         @default(now())
  isActive    Boolean          @default(true)
  userLoot    UserLootMoment[]

  @@index([trigger])
  @@index([rarity])
  @@index([isActive])
  @@index([createdAt(sort: Desc)])
  @@map("loot_moments")
}

model UserLootMoment {
  id          String     @id @default(cuid())
  userId      String
  momentId    String
  rewardData  Json // Store reward details
  triggeredAt DateTime   @default(now())
  redeemedAt  DateTime?
  moment      LootMoment @relation(fields: [momentId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, triggeredAt(sort: Desc)])
  @@index([userId, redeemedAt])
  @@index([momentId])
  @@map("user_loot_moments")
}

model Message {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  content          String
  isRead           Boolean  @default(false)
  receiverId       String
  senderId         String
  flagged          Boolean  @default(false)
  hiddenBySender   Boolean  @default(false)
  hiddenByReceiver Boolean  @default(false)
  receiver         User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  sender           User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
  @@map("messages")
}

model Comment {
  id         String            @id @default(cuid())
  userId     String
  targetType String?
  targetId   String
  content    String
  flagged    Boolean           @default(false)
  // Moderation (v0.27.6)
  isFlagged  Boolean           @default(false)
  flagReason String?
  visibility ContentVisibility @default(PUBLIC)
  createdAt  DateTime          @default(now())
  user       User              @relation("UserComments", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([targetType, targetId])
  @@index([visibility])
  @@index([createdAt])
  @@map("comments")
}

model ActionLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  metadata  Json?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("action_logs")
}

model ModerationLog {
  id          String   @id @default(cuid())
  moderatorId String
  action      String
  targetType String?
  targetId    String
  reason      String?
  createdAt   DateTime @default(now())
  moderator   User     @relation("ModeratorLogs", fields: [moderatorId], references: [id], onDelete: Cascade)

  @@index([moderatorId])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("moderation_logs")
}

/// v0.27.6 â€” Cultural Filters & Moderation Reports
enum CulturalFilterSeverity {
  info
  warn
  block
}

enum ContentVisibility {
  PUBLIC
  HIDDEN
}

model CulturalFilter {
  id          String                 @id @default(cuid())
  region      String
  tag         String
  category    String?
  description String?
  region          String?
  severity    CulturalFilterSeverity @default(warn)
  createdBy   String?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt

  @@index([region, tag])
  @@map("cultural_filters")
}

enum ModerationContentType {
  QUESTION
  EVENT
  COMMENT
}

model ModerationReport {
  id          String                @id @default(cuid())
  contentId   String
  type        ModerationContentType
  reasonTag   String
  region      String?
  reporterId  String?
  isAnonymous Boolean               @default(false)
  createdAt   DateTime              @default(now())

  @@index([type, region])
  @@map("moderation_reports")
}

/// v0.27.7 â€” AI Regional Contexts
model AIRegionalContext {
  id            String   @id @default(cuid())
  region        String // e.g., CZ, US, GLOBAL
  localeCode    String // e.g., cs-CZ, en-US
  toneProfile   String?
  culturalNotes String?  @db.Text
  humorStyle    String?
  tabooTopics   Json?
  updatedAt     DateTime @updatedAt

  @@index([region])
  @@index([localeCode])
  @@map("ai_regional_contexts")
}

/// v0.28.0 â€” Reflection Journal (Light)
model Reflection {
  id        String   @id @default(cuid())
  userId    String
  text      String   @db.VarChar(200)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("reflections")
}

/// v0.28.1 â€” Mini-Events System (removed duplicate - see MiniEvent model later in schema)

model Achievement {
  id                String                        @id @default(cuid())
  code              String                        @unique // Keep for backward compatibility
  key               String?                       @unique // New: semantic key like "first-blood"
  category          String                        @default("integration") // 'combat' | 'mind' | 'social' | 'commerce' | 'integration'
  tier              Int                           @default(1) // I=1, II=2, III=3
  title             String
  name              String? // Shorter display name (optional, use title if not set)
  description       String
  icon              String?
  emoji             String? // New: emoji for display
  xpReward          Int                           @default(50)
  rewardXp          Int? // Alternative field name (use xpReward as primary)
  rewardGold        Int                           @default(0)
  updatedAt         DateTime                      @default(now()) @updatedAt
  createdAt         DateTime                      @default(now())
  collectionMembers AchievementCollectionMember[]
  userAchievements  UserAchievement[]

  @@index([category])
  @@index([key])
  @@map("achievements")
}

model UserAchievement {
  id               String      @id @default(cuid())
  userId           String
  achievementId    String
  tier             Int         @default(1) // Track which tier was unlocked
  earnedAt         DateTime    @default(now())
  unlockedAt       DateTime? // Alternative field name (use earnedAt as primary)
  animationShownAt DateTime?
  achievement      Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user             User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId, tier]) // Allow same achievement multiple tiers
  @@index([userId])
  @@index([achievementId])
  @@index([userId, earnedAt])
  @@map("user_achievements")
}

model EventLog {
  id             String   @id @default(cuid())
  userId         String
  type String?
  title          String
  description String?
  region          String?
  metadata       Json?
  visibility     String   @default("public")
  reactionsCount Int      @default(0)
  createdAt      DateTime @default(now())
  eventType String?
  eventData      Json?
  user           User?    @relation("EventLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([type, createdAt])
  @@index([visibility, createdAt])
  @@index([reactionsCount, createdAt])
  @@map("event_logs")
}

model Waitlist {
  id        String   @id @default(cuid())
  email     String   @unique
  refCode   String?
  source    String   @default("landing")
  status    String   @default("pending")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("waitlist")
}

model MarketingCampaign {
  id             String    @id @default(cuid())
  title          String
  content        String
  link           String?
  status         String    @default("draft")
  sentAt         DateTime?
  deliveredCount Int       @default(0)
  openedCount    Int       @default(0)
  clickedCount   Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("marketing_campaigns")
}

model Activity {
  id          String       @id @default(cuid())
  userId      String
  type        ActivityType // v0.29.22 - Consolidated from activity_logs
  title       String
  description String?
  region          String?
  metadata    Json?
  createdAt   DateTime     @default(now())
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([type])
  @@map("activities")
}

model Presence {
  userId     String   @id
  status     String   @default("offline")
  lastActive DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("presence")
}

model Item {
  id              String          @id @default(cuid())
  name            String
  type String?
  slot            String?
  rarity          String          @default("common")
  description String?
  region          String?
  region          String?
  power           Int?
  defense         Int?
  effect          String?
  bonus Json?
  icon            String?
  key             String?         @unique // v0.26.2 - Semantic key for shop items (e.g. 'alpha-item')
  emoji           String? // v0.26.2 - Display emoji for shop
  createdAt       DateTime        @default(now())
  availableUntil  DateTime?
  cosmeticSubtype String?
  cosmeticType String?
  diamondPrice    Int?
  eventCurrency   String?
  eventPrice      Int?
  goldPrice       Int?
  isFeatured      Boolean         @default(false)
  isLimited       Boolean         @default(false)
  isShopItem      Boolean         @default(false)
  isTradable      Boolean         @default(true)
  isTradable      Boolean         @default(true)
  visualConfig    Json?
  culturalItems   CulturalItem[]
  dynamicPrice    DynamicPrice?
  inventoryItems  InventoryItem[]
  userItems       UserItem[]
  userItems       UserItem[]
  rarityId        String?
  rarityTier      RarityTier?     @relation(fields: [rarityId], references: [id], onDelete: SetNull)
  ItemRecipe      ItemRecipe[]
  ItemDiscovery   ItemDiscovery[]

  @@index([type, rarity])
  @@index([rarityId])
  @@index([cosmeticType, cosmeticSubtype])
  @@index([isShopItem, isFeatured])
  @@index([key]) // v0.26.2
  // Note: isCraftable and category indexes removed (v0.29.24) - fields don't exist yet
  @@map("items")
}

model InventoryItem {
  id             String          @id @default(cuid())
  userId         String
  itemId         String
  itemKey        String? // v0.26.5 - Denormalized item key for quick lookup
  rarity         String          @default("common") // v0.26.5 - Rarity tier (common, rare, epic, legendary, alpha)
  power          Int             @default(0) // v0.26.5 - Item power stat
  effectKey      String? // v0.26.5 - References ItemEffect.key
  quantity       Int             @default(1)
  equipped       Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt // v0.26.5
  item           Item            @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  effect         ItemEffect?     @relation(fields: [effectKey], references: [key], onDelete: SetNull) // v0.26.5
  marketListings MarketListing[]

  @@unique([userId, itemId])
  @@index([userId])
  @@index([itemId])
  @@index([rarity]) // v0.26.5
  @@index([equipped]) // v0.26.5
  @@map("inventory_items")
}


model UserItem {
  id          String   @id @default(cuid())
  userId      String
  itemId      String
  quantity    Int      @default(1)
  equipped    Boolean  @default(false)
  durability  Int?
  createdAt   DateTime @default(now())
  item        Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, itemId])
  @@index([userId])
  @@index([itemId])
  @@index([equipped])
  @@map("user_items")
}


model ItemEffect {
  key            String          @id // v0.26.5 - Unique effect key (e.g. 'life-steal', 'crit-bonus')
  name           String // v0.26.5 - Display name
  description    String // v0.26.5 - Effect description
  type String? // v0.26.5 - 'buff' | 'debuff' | 'passive'
  magnitude      Float // v0.26.5 - Effect strength/percentage
  trigger        String? // v0.26.5 - Trigger event (e.g. 'onAttack', 'onKill', 'onCrit', 'onStart')
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  inventoryItems  InventoryItem[]
  userItems       UserItem[] // v0.26.5

  @@index([type])
  @@index([trigger])
  @@map("item_effects")
}

model Friend {
  id         String    @id @default(cuid())
  userId     String
  friendId   String
  status     String    @default("pending")
  createdAt  DateTime  @default(now())
  acceptedAt DateTime?
  friend     User      @relation("FriendOf", fields: [friendId], references: [id], onDelete: Cascade)
  user       User      @relation("UserFriends", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
  @@index([userId, status])
  @@index([friendId, status])
  @@map("friends")
}

model Reaction {
  id         String   @id @default(cuid())
  userId     String
  targetType String?
  targetId   String
  emoji      String
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, targetType, targetId])
  @@index([targetType, targetId])
  @@map("reactions")
}

model Duel {
  id             String    @id @default(cuid())
  initiatorId    String
  receiverId     String
  categoryId     String?
  status         String    @default("pending")
  initiatorScore Int       @default(0)
  receiverScore  Int       @default(0)
  winnerId       String?
  createdAt      DateTime  @default(now())
  expiresAt      DateTime?
  completedAt    DateTime?
  initiator      User      @relation("DuelInitiator", fields: [initiatorId], references: [id], onDelete: Cascade)
  receiver       User      @relation("DuelReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([initiatorId, status])
  @@index([receiverId, status])
  @@index([status, expiresAt])
  @@map("duels")
}

model Challenge {
  id          String    @id @default(cuid())
  initiatorId String
  receiverId  String
  type String?    @default("random")
  categoryId  String?
  status      String    @default("pending")
  message     String?
  createdAt   DateTime  @default(now())
  respondedAt DateTime?
  completedAt DateTime?
  prompt      String?
  response    String?
  rewardKarma Int       @default(5)
  rewardXp    Int       @default(25)
  initiator   User      @relation("ChallengeInitiator", fields: [initiatorId], references: [id], onDelete: Cascade)
  receiver    User      @relation("ChallengeReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([initiatorId, status])
  @@index([receiverId, status])
  @@index([status, createdAt])
  @@map("challenges")
}

model GlobalEvent {
  id          String   @id @default(cuid())
  title       String
  description String?
  region          String?
  emoji       String?  @default("ðŸŽ‰")
  type String?
  bonusType String?
  bonusValue  Int
  targetScope String?
  startAt     DateTime
  endAt       DateTime
  active      Boolean  @default(true)
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([active, startAt, endAt])
  @@index([startAt, endAt])
  @@map("global_events")
}

model WeeklyChallenge {
  id               String                         @id @default(cuid())
  weekNumber       Int
  year             Int
  type String?                         @default("global")
  prompt           String
  dareVariant      String?
  truthVariant     String?
  generationSource String                         @default("ai")
  trendingTopics   Json?
  rewardXp         Int                            @default(100)
  rewardKarma      Int                            @default(10)
  participantCount Int                            @default(0)
  status           String                         @default("draft")
  publishedAt      DateTime?
  createdAt        DateTime                       @default(now())
  participations   WeeklyChallengeParticipation[]

  @@unique([weekNumber, year])
  @@index([status, publishedAt])
  @@map("weekly_challenges")
}

model WeeklyChallengeParticipation {
  id          String          @id @default(cuid())
  userId      String
  challengeId String
  response    String
  submitted   Boolean         @default(false)
  submittedAt DateTime?
  rewardXp    Int             @default(0)
  rewardKarma Int             @default(0)
  challenge   WeeklyChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, challengeId])
  @@index([challengeId, submitted])
  @@map("weekly_challenge_participations")
}

model UserInsight {
  id          String   @id @default(cuid())
  userId      String
  templateId  String
  title       String
  description String
  emoji       String
  color       String
  metrics     Json
  generatedAt DateTime @default(now())
  expiresAt   DateTime
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, generatedAt])
  @@index([expiresAt])
  @@map("user_insights")
}

model DailyQuest {
  id          String            @id @default(cuid())
  date        DateTime          @default(now())
  type String?
  title       String
  objective   String
  targetCount Int               @default(1)
  rewardXp    Int               @default(50)
  rewardGold  Int               @default(25)
  rewardItem  String?
  dropChance  Int               @default(0)
  expiresAt   DateTime
  createdAt   DateTime          @default(now())
  completions QuestCompletion[]

  @@index([date, expiresAt])
  @@map("daily_quests")
}

model QuestCompletion {
  id          String     @id @default(cuid())
  userId      String
  questId     String
  progress    Int        @default(0)
  completed   Boolean    @default(false)
  itemDropped String?
  completedAt DateTime?
  createdAt   DateTime   @default(now())
  quest       DailyQuest @relation(fields: [questId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, questId])
  @@index([userId, completed])
  @@map("quest_completions")
}

model MarketListing {
  id          String        @id @default(cuid())
  sellerId    String
  itemId      String // v0.26.4 - References InventoryItem.id (locked item instance)
  price       Int
  currencyKey String        @default("gold") // v0.26.4 - Currency key (gold, diamonds, etc.)
  status      String        @default("active") // active | sold | cancelled
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  buyerId     String?
  item        InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  seller      User          @relation("seller", fields: [sellerId], references: [id], onDelete: Cascade)
  buyer       User?         @relation("buyer", fields: [buyerId], references: [id], onDelete: SetNull)

  @@index([currencyKey, status]) // v0.26.4
  @@index([sellerId])
  @@index([buyerId])
  @@map("market_listings")
}

model GlobalPool {
  id            String   @id @default(cuid())
  poolType String?   @unique @default("market_tax")
  goldAmount    Int      @default(0)
  diamondAmount Int      @default(0)
  updatedAt     DateTime @updatedAt

  @@map("global_pool")
}

model CraftingRecipe {
  id            String   @id @default(cuid())
  name          String
  description String?
  region          String?
  inputItemIds  String[]
  outputItemId  String
  goldCost      Int      @default(0)
  requiresToken Boolean  @default(false)
  rarityBoost   Int      @default(0)
  successRate   Int      @default(95)
  craftingTime  Int      @default(0)
  unlockLevel   Int      @default(1)
  createdAt     DateTime @default(now())

  @@index([unlockLevel])
  @@map("crafting_recipes")
}

model CraftingLog {
  id             String   @id @default(cuid())
  userId         String
  recipeId       String?
  inputItems     Json
  outputItem     Json?
  success        Boolean
  goldSpent      Int
  rarityAchieved String?
  statVariance   Json?
  craftedAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, craftedAt])
  @@map("crafting_logs")
}

model DailyQuiz {
  id              String                @id @default(cuid())
  date            DateTime              @unique @default(now())
  questionIds     String[]
  rewardXp        Int                   @default(50)
  rewardHearts    Int                   @default(1)
  completions     Int                   @default(0)
  createdAt       DateTime              @default(now())
  userCompletions DailyQuizCompletion[]

  @@index([date])
  @@map("daily_quizzes")
}

model DailyQuizCompletion {
  id          String    @id @default(cuid())
  userId      String
  quizId      String
  score       Int
  completedAt DateTime  @default(now())
  quiz        DailyQuiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, quizId])
  @@index([userId])
  @@index([quizId])
  @@map("daily_quiz_completions")
}

model UserEnergy {
  id          String   @id @default(cuid())
  userId      String   @unique
  hearts      Int      @default(5)
  maxHearts   Int      @default(5)
  lastRegenAt DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_energy")
}

model GlobalFeedItem {
  id             String   @id @default(cuid())
  type String?
  title          String
  description String?
  region          String?
  userId         String
  metadata       Json?
  reactionsCount Int      @default(0)
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([reactionsCount, createdAt])
  @@index([userId])
  @@map("global_feed_items")
}

model ProfileTheme {
  id         String      @id @default(cuid())
  userId     String
  themeId    String
  isActive   Boolean     @default(false)
  unlockedAt DateTime    @default(now())
  rarityId   String?
  rarityTier RarityTier? @relation(fields: [rarityId], references: [id], onDelete: SetNull)
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, themeId])
  @@index([userId])
  @@index([rarityId])
  @@map("profile_themes")
}

model WorldChronicle {
  id              String          @id @default(cuid())
  seasonNumber    Int             @unique
  seasonName      String
  startDate       DateTime
  endDate         DateTime
  title           String
  summary         String
  fullChronicle   String
  totalPlayers    Int             @default(0)
  totalXpEarned   BigInt          @default(0)
  totalChallenges Int             @default(0)
  totalMessages   Int             @default(0)
  topFaction      String?
  topPlayer       String?
  topGroup        String?
  worldStateStart Json?
  worldStateEnd   Json?
  generatedBy     String          @default("ai")
  generatedAt     DateTime?
  isPublished     Boolean         @default(false)
  publishedAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  quotes          PlayerQuote[]
  summaries       SeasonSummary[]

  @@index([seasonNumber])
  @@index([isPublished])
  @@map("world_chronicles")
}

model SeasonSummary {
  id          String         @id @default(cuid())
  chronicleId String
  category    String
  title       String
  content     String
  highlights  Json?
  stats       Json?
  order       Int            @default(0)
  createdAt   DateTime       @default(now())
  chronicle   WorldChronicle @relation(fields: [chronicleId], references: [id], onDelete: Cascade)

  @@index([chronicleId, category])
  @@map("season_summaries")
}

model PlayerQuote {
  id          String         @id @default(cuid())
  chronicleId String
  userId      String
  quote       String
  context     String?
  sourceType String?
  sourceId    String?
  isFeatured  Boolean        @default(false)
  createdAt   DateTime       @default(now())
  chronicle   WorldChronicle @relation(fields: [chronicleId], references: [id], onDelete: Cascade)
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([chronicleId, isFeatured])
  @@map("player_quotes")
}

model NarrativeQuest {
  id          String             @id @default(cuid())
  userId      String
  title       String
  intro       String
  context     Json?
  generatedBy String             @default("ai")
  aiModel     String?
  prompt      String?
  status      String             @default("active")
  completedAt DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  choices     NarrativeChoice[]
  outcomes    NarrativeOutcome[]
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([status])
  @@map("narrative_quests")
}

model NarrativeChoice {
  id             String         @id @default(cuid())
  questId        String
  step           Int            @default(1)
  prompt         String
  option1        String
  option2        String
  option3        String?
  option1Effect  Json?
  option2Effect  Json?
  option3Effect  Json?
  selectedOption Int?
  selectedAt     DateTime?
  createdAt      DateTime       @default(now())
  quest          NarrativeQuest @relation(fields: [questId], references: [id], onDelete: Cascade)

  @@index([questId, step])
  @@map("narrative_choices")
}

model NarrativeOutcome {
  id             String         @id @default(cuid())
  questId        String
  conclusion     String
  karmaChange    Int            @default(0)
  prestigeChange Int            @default(0)
  xpReward       Int            @default(0)
  goldReward     Int            @default(0)
  archetypeShift Json?
  itemsGranted   String[]
  createdAt      DateTime       @default(now())
  quest          NarrativeQuest @relation(fields: [questId], references: [id], onDelete: Cascade)

  @@index([questId])
  @@map("narrative_outcomes")
}

model LoreEra {
  id          String      @id @default(cuid())
  name        String      @unique
  displayName String
  description String?
  region          String?
  order       Int         @unique
  startYear   Int?
  endYear     Int?
  isActive    Boolean     @default(false)
  isCurrent   Boolean     @default(false)
  icon        String?
  color       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  loreEntries LoreEntry[]

  @@index([order])
  @@map("lore_eras")
}

model LoreEntry {
  id                String    @id @default(cuid())
  title             String
  slug              String    @unique
  summary           String
  content           String
  eraId             String?
  author            String?
  publishedAt       DateTime?
  category          String?
  importance        Int       @default(1)
  relatedFactions   String[]
  relatedEvents     String[]
  relatedCharacters String[]
  isPublished       Boolean   @default(false)
  isSecret          Boolean   @default(false)
  viewCount         Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  era               LoreEra?  @relation(fields: [eraId], references: [id])
  tags              LoreTag[]

  @@index([slug])
  @@index([eraId])
  @@index([category])
  @@index([isPublished])
  @@map("lore_entries")
}

model LoreTag {
  id        String    @id @default(cuid())
  entryId   String
  tag       String
  createdAt DateTime  @default(now())
  entry     LoreEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  @@unique([entryId, tag])
  @@index([tag])
  @@map("lore_tags")
}

model UserTimeZone {
  id            String    @id @default(cuid())
  userId        String    @unique
  timezone      String
  utcOffset     Int
  detectedFrom  String?
  localMidnight DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([timezone])
  @@map("user_timezones")
}

model RegionSchedule {
  id                String    @id @default(cuid())
  region            String    @unique
  timezone          String
  dailyResetOffset  Int       @default(0)
  quizResetOffset   Int       @default(0)
  energyResetOffset Int       @default(0)
  nextDailyReset    DateTime?
  nextQuizReset     DateTime?
  nextEnergyReset   DateTime?
  updatedAt         DateTime  @updatedAt

  @@map("region_schedules")
}

model RegionalEvent {
  id          String   @id @default(cuid())
  name        String
  description String?
  region          String?
  region      String
  country     String?
  startDate   DateTime
  endDate     DateTime
  timezone    String?
  eventType String?
  theme       String?
  rewardXp    Int      @default(0)
  rewardGold  Int      @default(0)
  rewardItems Json?
  isActive    Boolean  @default(false)
  isRecurring Boolean  @default(false)
  recurrence  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([region, isActive])
  @@index([startDate, endDate])
  @@map("regional_events")
}

model RegionConfig {
  id                     String   @id @default(cuid())
  region                 String   @unique
  timezone               String
  locale                 String
  hasRegionalLeaderboard Boolean  @default(false)
  preferredThemes        Json?
  displayName            String
  flagEmoji              String?
  updatedAt              DateTime @updatedAt

  @@map("region_configs")
}

model CulturalItem {
  id              String   @id @default(cuid())
  itemId          String
  region          String
  culture         String?
  eventType String?
  eventName       String?
  isSeasonalOnly  Boolean  @default(false)
  availableMonths Int[]
  createdAt       DateTime @default(now())
  item            Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([region])
  @@index([eventType])
  @@map("cultural_items")
}

model LanguagePreference {
  id             String   @id @default(cuid())
  userId         String   @unique
  locale         String   @default("en")
  fallbackLocale String?  @default("en")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("language_preferences")
}

model TranslationKey {
  id        String   @id @default(cuid())
  key       String   @unique
  namespace String?
  en        String?
  cs        String?
  de        String?
  fr        String?
  es        String?
  jp        String?
  context   String?
  isMissing Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([namespace])
  @@index([isMissing])
  @@map("translation_keys")
}

model EconomyStat {
  id                 String   @id @default(cuid())
  date               DateTime @unique @db.Date
  totalGold          BigInt   @default(0)
  totalDiamonds      BigInt   @default(0)
  totalXp            BigInt   @default(0)
  goldCreated        BigInt   @default(0)
  goldDestroyed      BigInt   @default(0)
  diamondsCreated    BigInt   @default(0)
  diamondsDestroyed  BigInt   @default(0)
  marketTransactions Int      @default(0)
  marketVolume       BigInt   @default(0)
  craftingVolume     Int      @default(0)
  inflationRate      Float    @default(0.0)
  createdAt          DateTime @default(now())

  @@index([date])
  @@map("economy_stats")
}

model Treasury {
  id                String   @id @default(cuid())
  gold              BigInt   @default(0)
  diamonds          BigInt   @default(0)
  taxCollected      BigInt   @default(0)
  donationsReceived BigInt   @default(0)
  eventsSpent       BigInt   @default(0)
  projectsSpent     BigInt   @default(0)
  lifetimeCollected BigInt   @default(0)
  lifetimeSpent     BigInt   @default(0)
  updatedAt         DateTime @updatedAt

  @@map("treasury")
}

model DynamicPrice {
  id             String    @id @default(cuid())
  itemId         String    @unique
  basePrice      Int
  currentPrice   Int
  demand         Float     @default(1.0)
  supply         Float     @default(1.0)
  purchaseVolume Int       @default(0)
  craftingVolume Int       @default(0)
  lastAdjustedAt DateTime?
  priceHistory   Json?
  updatedAt      DateTime  @updatedAt
  item           Item      @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@map("dynamic_prices")
}

model TaxTransaction {
  id         String   @id @default(cuid())
  sourceType String?
  sourceId   String?
  amount     BigInt
  taxAmount  BigInt
  taxRate    Float    @default(0.05)
  currency   String
  userId     String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([sourceType])
  @@index([createdAt])
  @@map("tax_transactions")
}

model CreatorWallet {
  id              String               @id @default(cuid())
  userId          String               @unique
  pendingBalance  Int                  @default(0)
  paidBalance     Int                  @default(0)
  totalEarned     Int                  @default(0)
  stripeAccountId String?              @unique
  lastPayoutAt    DateTime?
  nextPayoutAt    DateTime?
  isActive        Boolean              @default(true)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  transactions    CreatorTransaction[]
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("creator_wallets")
}

model CreatorTransaction {
  id               String        @id @default(cuid())
  walletId         String
  type String?
  amount           Int
  sourceType String?
  sourceId         String?
  payoutPoolId     String?
  stripeTransferId String?
  description String?
  region          String?
  metadata         Json?
  createdAt        DateTime      @default(now())
  wallet           CreatorWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId, type])
  @@index([createdAt])
  @@map("creator_transactions")
}

model PayoutPool {
  id                String    @id @default(cuid())
  weekStart         DateTime  @db.Date
  weekEnd           DateTime  @db.Date
  totalPool         Int       @default(0)
  fromSubscriptions Int       @default(0)
  fromCosmetics     Int       @default(0)
  fromDonations     Int       @default(0)
  totalDistributed  Int       @default(0)
  totalCreators     Int       @default(0)
  status            String    @default("pending")
  calculatedAt      DateTime?
  distributedAt     DateTime?
  createdAt         DateTime  @default(now())

  @@unique([weekStart, weekEnd])
  @@index([status])
  @@map("payout_pools")
}

model EngagementMetric {
  id          String   @id @default(cuid())
  contentType String?
  contentId   String
  creatorId   String
  userId      String?
  type String?
  value       Float    @default(1.0)
  weekStart   DateTime @db.Date
  fingerprint String?
  createdAt   DateTime @default(now())
  creator     User     @relation("CreatorEngagements", fields: [creatorId], references: [id], onDelete: Cascade)
  user        User?    @relation("UserEngagements", fields: [userId], references: [id])

  @@unique([contentType, contentId, userId, type])
  @@index([creatorId, weekStart])
  @@index([contentType, contentId])
  @@index([weekStart])
  @@map("engagement_metrics")
}

model SubscriptionPlan {
  id              String             @id @default(cuid())
  name            String             @unique
  displayName     String
  description String?
  region          String?
  price           Int
  currency        String             @default("USD")
  interval        String
  stripeProductId String?            @unique
  stripePriceId   String?            @unique
  xpMultiplier    Float              @default(1.0)
  features        Json
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  subscriptions   UserSubscription[]

  @@map("subscription_plans")
}

model UserSubscription {
  id                   String           @id @default(cuid())
  userId               String
  planId               String
  stripeSubscriptionId String?          @unique
  stripeCustomerId     String?
  status               String           @default("active")
  startedAt            DateTime         @default(now())
  renewsAt             DateTime?
  cancelledAt          DateTime?
  expiresAt            DateTime?
  trialEndsAt          DateTime?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  payments             PaymentLog[]
  plan                 SubscriptionPlan @relation(fields: [planId], references: [id])
  user                 User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([stripeSubscriptionId])
  @@map("user_subscriptions")
}

model PaymentLog {
  id                    String            @id @default(cuid())
  subscriptionId        String?
  userId                String
  amount                Int
  currency              String            @default("USD")
  status                String
  stripePaymentIntentId String?           @unique
  stripeChargeId        String?
  description String?
  region          String?
  metadata              Json?
  failureReason         String?
  refundedAt            DateTime?
  createdAt             DateTime          @default(now())
  subscription          UserSubscription? @relation(fields: [subscriptionId], references: [id])
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([subscriptionId])
  @@index([stripePaymentIntentId])
  @@map("payment_logs")
}

model Report {
  id             String    @id @default(cuid())
  reporterId     String
  reportedUserId String?
  contentType String?
  contentId      String?
  reason         String
  description String?
  region          String?
  status         String    @default("pending")
  priority       String    @default("normal")
  resolvedBy     String?
  resolvedAt     DateTime?
  resolution     String?
  createdAt      DateTime  @default(now())
  reportedUser   User?     @relation("ReportsReceived", fields: [reportedUserId], references: [id])
  reporter       User      @relation("ReportsSubmitted", fields: [reporterId], references: [id], onDelete: Cascade)
  resolver       User?     @relation("ReportsResolved", fields: [resolvedBy], references: [id])

  @@index([reportedUserId, status])
  @@index([status, priority])
  @@index([createdAt])
  @@map("reports")
}

model ReputationScore {
  id                  String   @id @default(cuid())
  userId              String   @unique
  score               Float    @default(100.0)
  reportsReceived     Int      @default(0)
  reportsDismissed    Int      @default(0)
  positiveReactions   Int      @default(0)
  negativeReactions   Int      @default(0)
  challengesCompleted Int      @default(0)
  helpfulVotes        Int      @default(0)
  trustLevel          String   @default("neutral")
  isRestricted        Boolean  @default(false)
  canMessage          Boolean  @default(true)
  canChallenge        Boolean  @default(true)
  canPost             Boolean  @default(true)
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([score])
  @@index([trustLevel])
  @@map("reputation_scores")
}

model ModerationAction {
  id          String    @id @default(cuid())
  userId      String
  moderatorId String
  actionType String?
  reason      String
  duration    Int?
  reportId    String?
  isActive    Boolean   @default(true)
  expiresAt   DateTime?
  revokedAt   DateTime?
  revokedBy   String?
  isPublic    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  moderator   User      @relation("ModerationActionsPerformed", fields: [moderatorId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([moderatorId])
  @@index([actionType])
  @@index([expiresAt])
  @@map("moderation_actions")
}

model BlockedUser {
  id            String   @id @default(cuid())
  userId        String
  blockedUserId String
  reason        String?
  createdAt     DateTime @default(now())
  blockedUser   User     @relation("BlocksReceived", fields: [blockedUserId], references: [id], onDelete: Cascade)
  user          User     @relation("BlocksCreated", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, blockedUserId])
  @@index([userId])
  @@index([blockedUserId])
  @@map("blocked_users")
}

model ContentReview {
  id          String    @id @default(cuid())
  contentType String?
  contentId   String
  content     String
  flagged     Boolean   @default(false)
  confidence  Float?
  categories  String[]
  reviewed    Boolean   @default(false)
  reviewedBy  String?
  reviewedAt  DateTime?
  approved    Boolean?
  createdAt   DateTime  @default(now())

  @@unique([contentType, contentId])
  @@index([flagged, reviewed])
  @@index([createdAt])
  @@map("content_reviews")
}

model UserStreak {
  id              String    @id @default(cuid())
  userId          String    @unique
  currentStreak   Int       @default(0)
  longestStreak   Int       @default(0)
  lastLoginAt     DateTime?
  lastQuizAt      DateTime?
  lastDuelAt      DateTime?
  lastChallengeAt DateTime?
  loginStreak     Int       @default(0)
  quizStreak      Int       @default(0)
  duelStreak      Int       @default(0)
  totalDaysActive Int       @default(0)
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_streaks")
}

model RewardCalendar {
  id           String    @id @default(cuid())
  userId       String
  calendarType String?
  day          Int
  rewardType String?
  rewardAmount Int?
  rewardItemId String?
  claimed      Boolean   @default(false)
  claimedAt    DateTime?
  cycleStart   DateTime
  createdAt    DateTime  @default(now())
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, calendarType, day, cycleStart])
  @@index([userId, claimed])
  @@index([cycleStart])
  @@map("reward_calendars")
}

model ReturnBonus {
  id           String    @id @default(cuid())
  userId       String
  inactiveDays Int
  xpBonus      Int       @default(0)
  goldBonus    Int       @default(0)
  diamondBonus Int       @default(0)
  granted      Boolean   @default(false)
  grantedAt    DateTime?
  expiresAt    DateTime
  createdAt    DateTime  @default(now())
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, granted])
  @@index([expiresAt])
  @@map("return_bonuses")
}

model FeedbackMood {
  id        String   @id @default(cuid())
  userId    String
  emoji     String
  rating    Int
  context   String?
  sessionId String?
  comment   String?
  sentiment Float?
  analyzed  Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([context])
  @@map("feedback_moods")
}

model DailySummary {
  id                 String    @id @default(cuid())
  userId             String
  date               DateTime  @db.Date
  questionsAnswered  Int       @default(0)
  challengesSent     Int       @default(0)
  challengesReceived Int       @default(0)
  xpEarned           Int       @default(0)
  sessionCount       Int       @default(0)
  totalSessionTime   Int       @default(0)
  averageMood        Float?
  viewed             Boolean   @default(false)
  viewedAt           DateTime?
  createdAt          DateTime  @default(now())
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
  @@map("daily_summaries")
}

model BetaInvite {
  id             String     @id @default(cuid())
  code           String     @unique
  creatorId      String?
  maxUses        Int        @default(1)
  usedCount      Int        @default(0)
  rewardsGranted Boolean    @default(false)
  isActive       Boolean    @default(true)
  expiresAt      DateTime?
  source         String?
  utmSource      String?
  utmMedium      String?
  utmCampaign    String?
  createdAt      DateTime   @default(now())
  creator        User?      @relation("BetaInvitesCreated", fields: [creatorId], references: [id])
  referrals      Referral[]

  @@index([code])
  @@index([creatorId])
  @@index([isActive])
  @@map("beta_invites")
}

model Referral {
  id               String     @id @default(cuid())
  referrerId       String
  referredId       String     @unique
  inviteId         String
  xpRewarded       Int        @default(50)
  diamondsRewarded Int        @default(1)
  rewardsGranted   Boolean    @default(false)
  status           String     @default("pending")
  createdAt        DateTime   @default(now())
  rewardedAt       DateTime?
  invite           BetaInvite @relation(fields: [inviteId], references: [id], onDelete: Cascade)
  referred         User       @relation("ReferralsReceived", fields: [referredId], references: [id], onDelete: Cascade)
  referrer         User       @relation("ReferralsSent", fields: [referrerId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([status])
  @@map("referrals")
}

model BetaUser {
  id                 String    @id @default(cuid())
  userId             String    @unique
  inviteCode         String?
  wave               Int?
  firstLoginAt       DateTime?
  lastActiveAt       DateTime?
  onboardingComplete Boolean   @default(false)
  referralsSent      Int       @default(0)
  referralsAccepted  Int       @default(0)
  joinedAt           DateTime  @default(now())
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([wave])
  @@index([joinedAt])
  @@map("beta_users")
}

model TelemetryEvent {
  id          String   @id @default(cuid())
  type String?
  page        String?
  action      String?
  duration    Int?
  metadata    Json?
  userAgent   String?
  platform    String?
  sessionId   String?
  userId      String?
  anonymousId String?
  deviceType String?
  region      String?
  createdAt   DateTime @default(now())

  @@index([type, createdAt])
  @@index([sessionId])
  @@index([userId])
  @@index([createdAt])
  @@map("telemetry_events")
}

model TelemetryAggregate {
  id          String   @id @default(cuid())
  date        DateTime @db.Date
  type String?
  count       Int      @default(0)
  avgDuration Float?
  p50Duration Float?
  p95Duration Float?
  p99Duration Float?
  errorRate   Float?
  context     String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([date, type, context])
  @@index([date, type])
  @@map("telemetry_aggregates")
}

model UserPreferences {
  id                  String   @id @default(cuid())
  userId              String   @unique
  soundEnabled        Boolean  @default(true)
  soundVolume         Float    @default(0.5)
  levelUpSound        Boolean  @default(true)
  purchaseSound       Boolean  @default(true)
  challengeSound      Boolean  @default(true)
  notificationSound   Boolean  @default(true)
  ambientMusicEnabled Boolean  @default(false)
  ambientTheme        String?
  animationsEnabled   Boolean  @default(true)
  reducedMotion       Boolean  @default(false)
  particleEffects     Boolean  @default(true)
  backgroundAnimation Boolean  @default(true)
  transitionSpeed     String   @default("normal")
  glowEffects         Boolean  @default(true)
  shimmerEffects      Boolean  @default(true)
  confettiEnabled     Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model SoundAsset {
  id            String   @id @default(cuid())
  assetId       String   @unique
  name          String
  description String?
  region          String?
  filePath      String
  fileSize      Int?
  duration      Float?
  category      String
  eventType String?
  defaultVolume Float    @default(0.5)
  loop          Boolean  @default(false)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  @@index([category, isActive])
  @@map("sound_assets")
}

model OnboardingProgress {
  id                 String    @id @default(cuid())
  userId             String    @unique
  sawWelcomeOverlay  Boolean   @default(false)
  sawDashboard       Boolean   @default(false)
  completedAnswer    Boolean   @default(false)
  completedCompare   Boolean   @default(false)
  completedChallenge Boolean   @default(false)
  completedTutorial  Boolean   @default(false)
  tutorialStarted    Boolean   @default(false)
  tutorialStep       Int       @default(0)
  tutorialCompleted  Boolean   @default(false)
  tutorialReward     Boolean   @default(false)
  tooltipsSeen       String[]
  showTooltips       Boolean   @default(true)
  skipOnboarding     Boolean   @default(false)
  startedAt          DateTime  @default(now())
  completedAt        DateTime?
  lastStepAt         DateTime  @default(now())
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("onboarding_progress")
}

model FeedbackSubmission {
  id          String    @id @default(cuid())
  userId      String
  type String?
  category    String?
  title       String
  description String
  page        String?
  userAgent   String?
  screenshot  String?
  priority    String    @default("normal")
  status      String    @default("pending")
  adminNotes  String?
  respondedAt DateTime?
  respondedBy String?
  submittedAt DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, submittedAt])
  @@index([type, status])
  @@map("feedback_submissions")
}

model ErrorLog {
  id          String    @id @default(cuid())
  errorType String?
  message     String
  stack       String?   @db.Text
  page        String?
  userAgent   String?
  userId      String?
  sessionId   String?
  buildId     String?
  environment String?
  severity    String    @default("error")
  frequency   Int       @default(1)
  firstSeen   DateTime  @default(now())
  lastSeen    DateTime  @default(now())
  status      String    @default("new")
  assignedTo  String?
  metadata    Json?
  resolved    Boolean   @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([errorType, status])
  @@index([severity, resolved])
  @@index([createdAt])
  @@index([frequency])
  @@map("error_logs")
}

model TooltipDefinition {
  id           String   @id @default(cuid())
  tooltipId    String   @unique
  title        String
  description  String
  icon         String?
  page         String
  elementId    String?
  position     String   @default("bottom")
  showOnce     Boolean  @default(true)
  priority     Int      @default(5)
  delayMs      Int      @default(0)
  minLevel     Int      @default(0)
  maxLevel     Int      @default(999)
  requiresFlag String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  @@index([page, isActive])
  @@map("tooltip_definitions")
}

model WorldCycle {
  id                   String         @id @default(cuid())
  cycleNumber          Int            @unique
  cycleName            String
  startDate            DateTime
  endDate              DateTime?
  duration             Int
  finalHope            Float?
  finalChaos           Float?
  finalCreativity      Float?
  finalKnowledge       Float?
  finalHarmony         Float?
  dominantForce        String?
  totalPlayers         Int            @default(0)
  totalXp              Int            @default(0)
  threatsDefeated      Int            @default(0)
  eventsCompleted      Int            @default(0)
  topPlayerId          String?
  topFactionId         String?
  topClanId            String?
  unlockedFactions     String[]
  unlockedResources    String[]
  unlockedEnvironments String[]
  status               String         @default("active")
  legacyRecords        LegacyRecord[]

  @@index([cycleNumber, status])
  @@map("world_cycles")
}

model LegacyRecord {
  id              String     @id @default(cuid())
  cycleId         String
  userId          String
  finalLevel      Int
  finalXp         Int
  finalGold       Int
  finalDiamonds   Int
  finalPrestige   Int
  finalKarma      Int
  xpRank          Int?
  karmaRank       Int?
  prestigeRank    Int?
  achievements    String[]
  titles          String[]
  badges          String[]
  ascensionChoice String
  playTime        Int
  majorEvents     Json?
  archivedAt      DateTime   @default(now())
  cycle           WorldCycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([cycleId, userId])
  @@index([userId])
  @@map("legacy_records")
}

model UserLegacyBonus {
  id             String    @id @default(cuid())
  userId         String
  bonusType String?
  prestigeCarry  Int?
  legacyTitle    String?
  xpBoostPercent Float?
  mutation       String?
  artifactId     String?
  artifactType String?
  earnedInCycle  Int
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  expiresAt      DateTime?
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@map("user_legacy_bonuses")
}

model AbyssProgress {
  id              String    @id @default(cuid())
  userId          String    @unique
  currentLayer    Int       @default(0)
  maxLayer        Int       @default(0)
  totalClears     Int       @default(0)
  layerMultiplier Float     @default(1.0)
  abyssTokens     Int       @default(0)
  abyssArtifacts  String[]
  isActive        Boolean   @default(false)
  lastClear       DateTime?

  @@map("abyss_progress")
}

model WorldThreat {
  id               String         @id @default(cuid())
  threatId         String         @unique
  name             String
  title            String
  description      String
  loreText         String?
  avatar           String
  type String?
  difficulty       String
  maxHealth        Int
  currentHealth    Int
  defense          Int
  threatLevel      Int
  spawnedBy        String
  triggerMetrics   Json?
  region           String?
  controlledBy     String?
  status           String         @default("active")
  totalDamage      Int            @default(0)
  attackCount      Int            @default(0)
  participantCount Int            @default(0)
  xpReward         Int
  goldReward       Int
  specialReward    Json?
  spawnedAt        DateTime       @default(now())
  expiresAt        DateTime?
  defeatedAt       DateTime?
  isPostedToFeed   Boolean        @default(false)
  battles          ThreatBattle[]

  @@index([status, spawnedAt])
  @@index([difficulty, status])
  @@map("world_threats")
}

model ThreatBattle {
  id               String      @id @default(cuid())
  threatId         String
  userId           String?
  factionId        String?
  attackType String?
  damageDealt      Int
  isCritical       Boolean     @default(false)
  attackerLevel    Int
  attackerPrestige Int
  randomFactor     Float
  xpGained         Int         @default(0)
  goldGained       Int         @default(0)
  rewardClaimed    Boolean     @default(false)
  attackedAt       DateTime    @default(now())
  threat           WorldThreat @relation(fields: [threatId], references: [id], onDelete: Cascade)
  user             User?       @relation(fields: [userId], references: [id])

  @@index([threatId, attackedAt])
  @@index([userId])
  @@index([factionId])
  @@map("threat_battles")
}

model FactionTerritory {
  id              String    @id @default(cuid())
  territoryId     String    @unique
  name            String
  description String?
  region          String?
  region          String
  mapPosition     Json?
  controlledBy    String?
  controlStrength Int       @default(0)
  xpBonus         Float     @default(0.0)
  goldBonus       Float     @default(0.0)
  resourceType String?
  isContested     Boolean   @default(false)
  contestStarted  DateTime?
  lastCaptured    DateTime?
  captureCount    Int       @default(0)

  @@index([region, controlledBy])
  @@index([isContested])
  @@map("faction_territories")
}

model TerritoryContest {
  id              String    @id @default(cuid())
  territoryId     String
  attackerFaction String
  defenderFaction String?
  attackerScore   Int       @default(0)
  defenderScore   Int       @default(0)
  startTime       DateTime  @default(now())
  endTime         DateTime
  status          String    @default("active")
  winnerId        String?
  completedAt     DateTime?

  @@index([territoryId, status])
  @@map("territory_contests")
}

model FactionLegacy {
  id              String          @id @default(cuid())
  factionId       String          @unique
  name            String
  title           String
  description     String
  color           String
  secondaryColor  String
  emblem          String
  pattern         String?
  glowEffect      String?
  moralAxis       String
  orderAxis       String
  philosophy      String
  xpBonus         Float           @default(0.0)
  goldBonus       Float           @default(0.0)
  karmaMultiplier Float           @default(1.0)
  specialAbility  String?
  memberCount     Int             @default(0)
  totalXp         Int             @default(0)
  avgKarma        Float           @default(0.0)
  avgPrestige     Float           @default(0.0)
  hasCouncil      Boolean         @default(false)
  councilSize     Int             @default(5)
  votingPower     String          @default("karma_based")
  lore            String?
  motto           String?
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  members         FactionMember[]
  votes           FactionVote[]

  @@index([isActive, memberCount])
  @@map("factions_legacy")
}

model FactionMember {
  id               String        @id @default(cuid())
  factionId        String
  userId           String        @unique
  role             String        @default("member")
  rank             Int           @default(0)
  title            String?
  xpContributed    Int           @default(0)
  karmaContributed Int           @default(0)
  reputation       Int           @default(0)
  loyaltyScore     Int           @default(50)
  joinedAt         DateTime      @default(now())
  lastActive       DateTime      @default(now())
  canSwitchAt      DateTime?
  switchCount      Int           @default(0)
  faction          FactionLegacy @relation(fields: [factionId], references: [id], onDelete: Cascade)
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([factionId, role])
  @@index([userId])
  @@map("faction_members")
}

model FactionChangeLog {
  id             String   @id @default(cuid())
  userId         String
  fromFactionId  String?
  toFactionId    String?
  changeType String?
  reason         String?
  penaltyType String?
  penaltyAmount  Int?
  questCompleted Boolean?
  changedAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, changedAt])
  @@map("faction_change_logs")
}

model FactionVote {
  id          String        @id @default(cuid())
  factionId   String
  userId      String
  voteType String?
  proposalId  String
  vote        String
  votingPower Int
  comment     String?
  votedAt     DateTime      @default(now())
  faction     FactionLegacy @relation(fields: [factionId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([proposalId, userId])
  @@index([factionId, voteType])
  @@map("faction_votes")
}

model FactionProposal {
  id           String    @id @default(cuid())
  proposalId   String    @unique
  factionId    String?
  title        String
  description  String
  proposalType String?
  status       String    @default("active")
  votesFor     Int       @default(0)
  votesAgainst Int       @default(0)
  votesAbstain Int       @default(0)
  startTime    DateTime  @default(now())
  endTime      DateTime
  result       String?
  executedAt   DateTime?
  createdBy    String
  createdAt    DateTime  @default(now())

  @@index([factionId, status])
  @@index([status, endTime])
  @@map("faction_proposals")
}

model MentorProfile {
  id                 String    @id @default(cuid())
  userId             String    @unique
  mentorName         String    @default("Sage")
  mentorAvatar       String    @default("ðŸ§™")
  mentorTone         String    @default("supportive")
  preferredTopics    String[]
  communicationStyle String    @default("balanced")
  reminderFrequency  String    @default("weekly")
  lastAnalyzedAt     DateTime?
  currentFocus       String?
  growthAreas        String[]
  strengths          String[]
  isEnabled          Boolean   @default(true)
  journalingEnabled  Boolean   @default(false)
  reflectionPrompts  Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("mentor_profiles")
}

model MentorLog {
  id          String    @id @default(cuid())
  userId      String
  logType String?
  title       String
  message     String
  category    String?
  timeframe   String?
  metrics     Json?
  suggestions String[]
  flowLinks   String[]
  isRead      Boolean   @default(false)
  readAt      DateTime?
  userRating  Int?
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([logType, createdAt])
  @@map("mentor_logs")
}

model InsightPrompt {
  id                String   @id @default(cuid())
  promptId          String   @unique
  category          String
  question          String
  subtext           String?
  icon              String   @default("ðŸ’­")
  archetypes        String[]
  minLevel          Int      @default(1)
  karmaRange        Json?
  expectedWordCount Int?
  tags              String[]
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())

  @@index([category, isActive])
  @@map("insight_prompts")
}

model ReflectionEntry {
  id         String   @id @default(cuid())
  userId     String
  promptId   String?
  title      String?
  content    String
  mood       String?
  aiInsights String?
  themes     String[]
  sentiment  String?
  isPrivate  Boolean  @default(true)
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Locale code (v0.27.1)
  localeCode String?  @default("global")

  @@index([userId, createdAt])
  @@index([localeCode])
  @@map("reflection_entries")
}

model WorldState {
  id               String          @id @default(cuid())
  timestamp        DateTime        @unique @default(now())
  hope             Float           @default(50.0)
  chaos            Float           @default(50.0)
  creativity       Float           @default(50.0)
  knowledge        Float           @default(50.0)
  harmony          Float           @default(50.0)
  overallAlignment String          @default("balanced")
  dominantForce    String?
  totalPlayers     Int             @default(0)
  activeEvents     Int             @default(0)
  dayNumber        Int             @default(1)
  hopeChange       Float           @default(0.0)
  chaosChange      Float           @default(0.0)
  creativityChange Float           @default(0.0)
  knowledgeChange  Float           @default(0.0)
  harmonyChange    Float           @default(0.0)
  variables        WorldVariable[]

  @@index([timestamp])
  @@map("world_states")
}

model WorldVariable {
  id           String     @id @default(cuid())
  stateId      String
  variableName String
  value        Float
  category     String?
  state        WorldState @relation(fields: [stateId], references: [id], onDelete: Cascade)

  @@unique([stateId, variableName])
  @@index([stateId])
  @@map("world_variables")
}

model WorldEvent {
  id                String    @id @default(cuid())
  eventId           String    @unique
  name              String
  description       String
  loreText          String?
  triggerType String?
  triggerConditions Json
  variableImpacts   Json
  duration          Int?
  status            String    @default("pending")
  triggeredAt       DateTime  @default(now())
  startsAt          DateTime?
  endsAt            DateTime?
  completedAt       DateTime?
  participantCount  Int       @default(0)
  requiredActions   Int?
  currentProgress   Int       @default(0)
  rewards           Json?
  isPostedToFeed    Boolean   @default(false)

  @@index([status, triggeredAt])
  @@index([triggerType])
  @@map("world_events")
}

model WorldContribution {
  id                String   @id @default(cuid())
  userId            String
  date              DateTime @default(now())
  hopePoints        Float    @default(0.0)
  chaosPoints       Float    @default(0.0)
  creativityPoints  Float    @default(0.0)
  knowledgePoints   Float    @default(0.0)
  harmonyPoints     Float    @default(0.0)
  fromAnswers       Int      @default(0)
  fromChallenges    Int      @default(0)
  fromFlows         Int      @default(0)
  fromSocialActions Int      @default(0)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@map("world_contributions")
}

model NpcProfile {
  id                String            @id @default(cuid())
  npcId             String            @unique
  name              String
  title             String?
  avatar            String
  archetypeAffinity ArchetypeAffinity // v0.29.23 - Primary archetype match (thinker|trickster|guardian|wanderer|chaos)
  tone              NPCTone // v0.29.23 - Dialogue tone (serious|sarcastic|poetic|neutral)
  bio               String? // v0.29.23 - NPC biography
  portraitUrl       String? // v0.29.23 - Portrait image URL
  personality       Json?
  alignment         String?
  karmaAffinity     Int               @default(0)
  archetypeMatch    String[]
  greetings         Json?
  farewells         Json?
  quirks            String[]
  canGiveQuests     Boolean           @default(true)
  canGiveRewards    Boolean           @default(true)
  canGiveAdvice     Boolean           @default(true)
  isActive          Boolean           @default(true)
  appearanceRate    Float             @default(1.0)
  minLevel          Int               @default(1)
  backstory         String?
  voice             String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  interactions      NpcInteraction[]
  memories          NpcMemory[]
  dialogues         NPCDialogue[] // v0.29.23 - Dialogue lines
  affinities        NpcAffinity[] // v0.29.29 - User affinity tracking

  @@index([archetypeAffinity, isActive]) // v0.29.23 - Updated index
  @@index([isActive, appearanceRate])
  @@map("npc_profiles")
}

model NpcInteraction {
  id              String     @id @default(cuid())
  npcId           String
  userId          String
  interactionType String?
  userArchetype String?
  userKarma       Int?
  userPrestige    Int?
  npcMessage      String
  userResponse    String?
  sentiment       String?
  questOffered    String?
  rewardGiven     Json?
  adviceGiven     String?
  duration        Int?
  createdAt       DateTime   @default(now())
  npc             NpcProfile @relation(fields: [npcId], references: [id], onDelete: Cascade)
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([npcId, createdAt])
  @@map("npc_interactions")
}

model NpcMemory {
  id           String     @id @default(cuid())
  npcId        String
  userId       String
  memoryType String?
  key          String
  value        Json
  importance   Int        @default(1)
  lastAccessed DateTime   @default(now())
  accessCount  Int        @default(0)
  createdAt    DateTime   @default(now())
  expiresAt    DateTime?
  npc          NpcProfile @relation(fields: [npcId], references: [id], onDelete: Cascade)

  @@unique([npcId, userId, key])
  @@index([npcId, userId])
  @@index([expiresAt])
  @@map("npc_memories")
}

// NPC Affinity model (v0.29.29) - Persistent character reactions & affinity tracking
model NpcAffinity {
  id             String     @id @default(cuid())
  userId         String
  npcId          String
  lastInteraction DateTime  @default(now())
  affinityScore  Float      @default(0.0)
  note           String?    // Optional note about relationship
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  npc            NpcProfile @relation(fields: [npcId], references: [id], onDelete: Cascade)
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, npcId])
  @@index([userId, npcId])
  @@index([affinityScore])
  @@index([lastInteraction])
  @@map("npc_affinities")
}

// NPC Dialogue model (v0.29.23)
model NPCDialogue {
  id          String              @id @default(cuid())
  npcId       String
  triggerType DialogueTriggerType // greeting|quest|reflection|event|random
  text        String              @db.Text
  moodTag     String? // Optional mood tag for filtering
  rarity      DialogueRarity      @default(common) // common|rare|epic
  createdAt   DateTime            @default(now())
  npc         NpcProfile          @relation(fields: [npcId], references: [id], onDelete: Cascade)

  @@index([npcId, triggerType])
  @@index([npcId, rarity])
  @@map("npc_dialogues")
}

model NpcDialogueTree {
  id          String   @id @default(cuid())
  npcId       String
  treeId      String   @unique
  name        String
  description String?
  region          String?
  triggerType String?
  conditions  Json
  nodes       Json
  category    String?
  priority    Int      @default(5)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@index([npcId, isActive])
  @@map("npc_dialogue_trees")
}

model RewardOffer {
  id             String             @id @default(cuid())
  offerId        String             @unique
  name           String
  description    String
  type String?
  partnerId      String?
  partnerName    String
  partnerLogo    String?
  minPrestige    Int                @default(0)
  minLevel       Int                @default(1)
  requiredBadges String[]
  requiredTitles String[]
  value          String
  rewardCode     String?
  qrCodeUrl      String?
  externalUrl    String?
  totalStock     Int?
  remainingStock Int?
  maxPerUser     Int                @default(1)
  isActive       Boolean            @default(true)
  startsAt       DateTime?
  expiresAt      DateTime?
  category       String?
  imageUrl       String?
  termsUrl       String?
  nftEnabled     Boolean            @default(false)
  nftContract    String?
  nftMetadata    Json?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  redemptions    RewardRedemption[]

  @@index([isActive, startsAt, expiresAt])
  @@index([type, category])
  @@index([minPrestige, minLevel])
  @@map("reward_offers")
}

model RewardRedemption {
  id               String      @id @default(cuid())
  offerId          String
  userId           String
  redemptionCode   String      @unique
  qrCode           String?
  status           String      @default("claimed")
  verificationCode String?
  verifiedAt       DateTime?
  verifiedBy       String?
  redeemedAt       DateTime?
  expiresAt        DateTime
  nftMinted        Boolean     @default(false)
  nftTokenId       String?
  nftTxHash        String?
  metadata         Json?
  notes            String?
  createdAt        DateTime    @default(now())
  offer            RewardOffer @relation(fields: [offerId], references: [id], onDelete: Cascade)
  user             User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([offerId, status])
  @@index([redemptionCode])
  @@index([expiresAt])
  @@map("reward_redemptions")
}

model RewardProof {
  id           String    @id @default(cuid())
  redemptionId String    @unique
  proofType String?
  proofData    Json
  uploadedAt   DateTime  @default(now())
  verifiedAt   DateTime?
  isVerified   Boolean   @default(false)

  @@index([redemptionId])
  @@map("reward_proofs")
}

model PartnerApp {
  id               String          @id @default(cuid())
  name             String
  description String?
  region          String?
  website          String?
  contactEmail     String
  clientId         String          @unique
  clientSecret     String
  status           String          @default("pending")
  tier             String          @default("free")
  rateLimit        Int             @default(1000)
  dailyLimit       Int             @default(10000)
  webhookUrl       String?
  webhookSecret    String?
  webhookEvents    String[]
  canEmbed         Boolean         @default(true)
  canAccessData    Boolean         @default(false)
  canCreateContent Boolean         @default(false)
  logoUrl          String?
  industry         String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  lastUsedAt       DateTime?
  apiKeys          PartnerApiKey[]
  stats            PartnerStats[]

  @@index([status, tier])
  @@index([clientId])
  @@map("partner_apps")
}

model PartnerApiKey {
  id         String     @id @default(cuid())
  partnerId  String
  keyHash    String
  keyPreview String
  name       String?
  scopes     String[]
  isActive   Boolean    @default(true)
  expiresAt  DateTime?
  lastUsedAt DateTime?
  usageCount Int        @default(0)
  createdAt  DateTime   @default(now())
  revokedAt  DateTime?
  partner    PartnerApp @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId, isActive])
  @@index([keyHash])
  @@map("partner_api_keys")
}

model PartnerStats {
  id              String     @id @default(cuid())
  partnerId       String
  date            DateTime   @default(now())
  totalRequests   Int        @default(0)
  successRequests Int        @default(0)
  failedRequests  Int        @default(0)
  rateLimitHits   Int        @default(0)
  embedViews      Int        @default(0)
  embedClicks     Int        @default(0)
  embedResponses  Int        @default(0)
  questionsServed Int        @default(0)
  answersReceived Int        @default(0)
  uniqueUsers     Int        @default(0)
  avgResponseTime Float?
  errorRate       Float?
  partner         PartnerApp @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@unique([partnerId, date])
  @@index([partnerId, date])
  @@map("partner_stats")
}

model PartnerWebhook {
  id          String    @id @default(cuid())
  partnerId   String
  eventType String?
  payload     Json
  signature   String
  status      String    @default("pending")
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  deliveredAt DateTime?
  failedAt    DateTime?
  error       String?
  nextRetryAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([partnerId, status])
  @@index([status, nextRetryAt])
  @@map("partner_webhooks")
}

model PushSubscription {
  id         String   @id @default(cuid())
  userId     String
  endpoint   String   @unique
  keys       Json
  userAgent  String?
  deviceType String?
  isEnabled  Boolean  @default(true)
  createdAt  DateTime @default(now())
  lastUsed   DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isEnabled])
  @@map("push_subscriptions")
}

model OfflineAction {
  id         String    @id @default(cuid())
  userId     String
  actionType String?
  payload    Json
  status     String    @default("pending")
  retryCount Int       @default(0)
  createdAt  DateTime  @default(now())
  syncedAt   DateTime?
  error      String?
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([status, createdAt])
  @@map("offline_actions")
}

model PWAMetrics {
  id             String   @id @default(cuid())
  date           DateTime @unique @default(now())
  installCount   Int      @default(0)
  uninstallCount Int      @default(0)
  activeInstalls Int      @default(0)
  mobileUsers    Int      @default(0)
  tabletUsers    Int      @default(0)
  desktopUsers   Int      @default(0)
  pushSent       Int      @default(0)
  pushDelivered  Int      @default(0)
  pushClicked    Int      @default(0)
  offlineActions Int      @default(0)
  syncedActions  Int      @default(0)
  failedActions  Int      @default(0)
  avgLoadTime    Float?
  cacheHitRate   Float?

  @@index([date])
  @@map("pwa_metrics")
}

model MiniEvent {
  id               String              @id @default(cuid())
  eventId          String              @unique
  name             String
  description      String
  icon             String              @default("ðŸŽ¯")
  eventType String?
  goalType String?
  targetCount      Int
  currentProgress  Int                 @default(0)
  duration         Int
  startTime        DateTime
  endTime          DateTime
  rewards          Json
  status           String              @default("scheduled")
  participantCount Int                 @default(0)
  isSuccessful     Boolean?
  completedAt      DateTime?
  createdAt        DateTime            @default(now())
  progress         MiniEventProgress[]

  @@index([status, startTime, endTime])
  @@index([eventType, status])
  @@map("mini_events")
}

model MiniEventProgress {
  id             String    @id @default(cuid())
  eventId        String
  userId         String
  contribution   Int       @default(0)
  lastUpdate     DateTime  @default(now())
  rewardsClaimed Boolean   @default(false)
  claimedAt      DateTime?
  event          MiniEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId, contribution])
  @@index([userId])
  @@map("mini_event_progress")
}

model MiniEventReward {
  id          String   @id @default(cuid())
  eventId     String
  userId      String
  rewardType String?
  rewardId    String?
  amount      Int?
  description String
  awardedAt   DateTime @default(now())

  @@index([eventId, userId])
  @@index([userId, awardedAt])
  @@map("mini_event_rewards")
}

model CreatorProfile {
  id              String            @id @default(cuid())
  userId          String            @unique
  displayName     String
  bio             String?
  avatar          String?
  bannerImage     String?
  isVerified      Boolean           @default(false)
  badge           String            @default("ðŸŽ¨")
  tier            String            @default("basic")
  totalFlows      Int               @default(0)
  totalEngagement Int               @default(0)
  totalEarnings   Int               @default(0)
  followerCount   Int               @default(0)
  revenueShare    Float             @default(0.10)
  goldPerPlay     Int               @default(0)
  isActive        Boolean           @default(true)
  allowComments   Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  flows           CreatorFlow[]
  followers       CreatorFollower[]
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  rewards         CreatorReward[]

  @@index([isVerified, isActive])
  @@index([totalEngagement, followerCount])
  @@map("creator_profiles")
}

model CreatorFlow {
  id              String         @id @default(cuid())
  creatorId       String
  title           String
  description String?
  region          String?
  coverImage      String?
  difficulty      String         @default("medium")
  category        String
  tags            String[]
  questions       Json
  questionCount   Int            @default(0)
  status          String         @default("draft")
  approvedBy      String?
  approvedAt      DateTime?
  publishedAt     DateTime?
  rejectionReason String?
  playCount       Int            @default(0)
  completionCount Int            @default(0)
  avgRating       Float?
  ratingCount     Int            @default(0)
  xpReward        Int            @default(50)
  goldReward      Int            @default(0)
  isFeatured      Boolean        @default(false)
  isPremium       Boolean        @default(false)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  creator         CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId, status])
  @@index([status, publishedAt])
  @@index([category, difficulty])
  @@index([isFeatured, playCount])
  @@map("creator_flows")
}

model CreatorFollower {
  id         String         @id @default(cuid())
  creatorId  String
  userId     String
  followedAt DateTime       @default(now())
  creator    CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  user       User           @relation("UserFollowing", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([creatorId, userId])
  @@index([creatorId])
  @@index([userId])
  @@map("creator_followers")
}

model CreatorReward {
  id          String         @id @default(cuid())
  creatorId   String
  flowId      String?
  type String?
  amount      Int
  source      String
  description String
  earnedAt    DateTime       @default(now())
  creator     CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId, earnedAt])
  @@map("creator_rewards")
}

model Clan {
  id                String         @id @default(cuid())
  name              String         @unique
  tag               String         @unique
  description String?
  region          String?
  emblem            String         @default("ðŸ°")
  color             String         @default("#8b5cf6")
  leaderId          String
  totalXp           Int            @default(0)
  weeklyXp          Int            @default(0)
  clanGold          Int            @default(0)
  level             Int            @default(1)
  memberCount       Int            @default(0)
  maxMembers        Int            @default(50)
  isPublic          Boolean        @default(true)
  requireApproval   Boolean        @default(false)
  minLevel          Int            @default(1)
  lastXpReset       DateTime       @default(now())
  totalChestsEarned Int            @default(0)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  activities        ClanActivity[]
  members           ClanMember[]
  upgrades          ClanUpgrade[]

  @@index([totalXp, weeklyXp])
  @@index([isPublic, requireApproval])
  @@map("clans")
}

model ClanMember {
  id                  String   @id @default(cuid())
  clanId              String
  userId              String   @unique
  role                String   @default("member")
  xpContributed       Int      @default(0)
  weeklyXpContributed Int      @default(0)
  goldContributed     Int      @default(0)
  rank                Int      @default(0)
  title               String?
  joinedAt            DateTime @default(now())
  lastActive          DateTime @default(now())
  clan                Clan     @relation(fields: [clanId], references: [id], onDelete: Cascade)
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clanId, userId])
  @@index([clanId, role])
  @@index([userId])
  @@map("clan_members")
}

model ClanUpgrade {
  id          String    @id @default(cuid())
  clanId      String
  upgradeType String?
  name        String
  level       Int       @default(1)
  maxLevel    Int       @default(5)
  boostAmount Float?
  duration    Int?
  purchasedAt DateTime  @default(now())
  expiresAt   DateTime?
  clan        Clan      @relation(fields: [clanId], references: [id], onDelete: Cascade)

  @@unique([clanId, upgradeType])
  @@index([clanId])
  @@map("clan_upgrades")
}

model ClanActivity {
  id           String   @id @default(cuid())
  clanId       String
  activityType String?
  userId       String?
  message      String
  metadata     Json?
  createdAt    DateTime @default(now())
  clan         Clan     @relation(fields: [clanId], references: [id], onDelete: Cascade)

  @@index([clanId, createdAt])
  @@map("clan_activities")
}

model SystemMetric {
  id         String   @id @default(cuid())
  metricType String?
  name       String
  value      Float
  unit       String
  endpoint   String?
  timestamp  DateTime @default(now())

  @@index([metricType, timestamp])
  @@index([endpoint, timestamp])
  @@map("system_metrics")
}

model HealthLog {
  id           String   @id @default(cuid())
  checkType String?
  status       String
  message      String?
  responseTime Float?
  metadata     Json?
  checkedAt    DateTime @default(now())

  @@index([checkType, checkedAt])
  @@index([status, checkedAt])
  @@map("health_logs")
}

model AutoHealLog {
  id            String   @id @default(cuid())
  healType String?
  description   String
  itemsAffected Int      @default(0)
  success       Boolean  @default(true)
  error         String?
  executedAt    DateTime @default(now())

  @@index([healType, executedAt])
  @@map("auto_heal_logs")
}

model CronJobLog {
  id           String        @id @default(cuid())
  jobKey       String
  status       CronJobStatus
  startedAt    DateTime      @default(now())
  finishedAt   DateTime?
  durationMs   Int?
  errorMessage String?       @db.Text

  @@index([jobKey, startedAt(sort: Desc)])
  @@map("cron_job_logs")
}

model ErrorAlert {
  id         String    @id @default(cuid())
  severity   String
  source     String
  message    String
  stackTrace String?
  metadata   Json?
  notifiedAt DateTime?
  resolvedAt DateTime?
  isResolved Boolean   @default(false)
  createdAt  DateTime  @default(now())

  @@index([severity, isResolved, createdAt])
  @@index([source, createdAt])
  @@map("error_alerts")
}

model JobQueue {
  id              String            @id @default(cuid())
  queueName       String            @unique
  displayName     String
  description String?
  region          String?
  priority        Int               @default(5)
  concurrency     Int               @default(1)
  maxRetries      Int               @default(3)
  backoffStrategy String            @default("exponential")
  backoffDelay    Int               @default(1000)
  isEnabled       Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  metrics         JobQueueMetrics[]

  @@index([priority, isEnabled])
  @@map("job_queues")
}

model JobQueueMetrics {
  id              String   @id @default(cuid())
  queueName       String
  date            DateTime @default(now())
  processed       Int      @default(0)
  completed       Int      @default(0)
  failed          Int      @default(0)
  retried         Int      @default(0)
  stalled         Int      @default(0)
  avgProcessTime  Float?
  maxProcessTime  Float?
  minProcessTime  Float?
  processedPerSec Float?
  failureRate     Float?
  queue           JobQueue @relation(fields: [queueName], references: [queueName], onDelete: Cascade)

  @@unique([queueName, date])
  @@index([queueName, date])
  @@index([date])
  @@map("job_queue_metrics")
}

model JobFailure {
  id          String    @id @default(cuid())
  queueName   String
  jobId       String
  jobName     String
  payload     Json?
  error       String
  stackTrace  String?
  attempts    Int       @default(1)
  maxRetries  Int
  willRetry   Boolean
  nextRetryAt DateTime?
  failedAt    DateTime  @default(now())
  resolvedAt  DateTime?
  isResolved  Boolean   @default(false)

  @@index([queueName, failedAt])
  @@index([isResolved, failedAt])
  @@map("job_failures")
}

model CacheConfig {
  id           String   @id @default(cuid())
  key          String   @unique
  name         String
  description String?
  region          String?
  ttlSeconds   Int      @default(60)
  isEnabled    Boolean  @default(true)
  strategy     String   @default("redis")
  invalidateOn String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([key, isEnabled])
  @@map("cache_configs")
}

model CacheMetrics {
  id          String    @id @default(cuid())
  cacheKey    String
  endpoint    String
  hitCount    Int       @default(0)
  missCount   Int       @default(0)
  avgHitTime  Float?
  avgMissTime Float?
  lastHitAt   DateTime?
  lastMissAt  DateTime?
  date        DateTime  @default(now())

  @@unique([cacheKey, endpoint, date])
  @@index([endpoint, date])
  @@index([cacheKey, date])
  @@map("cache_metrics")
}

model AchievementCollection {
  id              String                        @id @default(cuid())
  collectionId    String                        @unique
  name            String
  description String?
  region          String?
  theme           String
  icon            String?
  rarity          String                        @default("common")
  titleReward     String?
  xpReward        Int                           @default(0)
  goldReward      Int                           @default(0)
  diamondReward   Int                           @default(0)
  auraUnlock      String?
  themeUnlock     String?
  isSeasonal      Boolean                       @default(false)
  seasonType String?
  isEvent         Boolean                       @default(false)
  eventId         String?
  availableFrom   DateTime?
  availableUntil  DateTime?
  isActive        Boolean                       @default(true)
  createdAt       DateTime                      @default(now())
  members         AchievementCollectionMember[]
  userCompletions UserAchievementCollection[]

  @@index([theme, rarity])
  @@index([isSeasonal, seasonType])
  @@index([isEvent, eventId])
  @@index([isActive, availableFrom, availableUntil])
  @@map("achievement_collections")
}

model AchievementCollectionMember {
  id            String                @id @default(cuid())
  collectionId  String
  achievementId String
  sortOrder     Int                   @default(0)
  achievement   Achievement           @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  collection    AchievementCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([collectionId, achievementId])
  @@index([collectionId, sortOrder])
  @@map("achievement_collection_members")
}

model UserAchievementCollection {
  id            String                @id @default(cuid())
  userId        String
  collectionId  String
  progress      Int                   @default(0)
  totalRequired Int
  isCompleted   Boolean               @default(false)
  completedAt   DateTime?
  rewardClaimed Boolean               @default(false)
  claimedAt     DateTime?
  collection    AchievementCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, collectionId])
  @@index([userId, isCompleted])
  @@index([collectionId])
  @@map("user_achievement_collections")
}

model ThemePack {
  id              String    @id @default(cuid())
  themeId         String    @unique
  name            String
  description String?
  region          String?
  type String?
  rarity          String    @default("common")
  isSeasonal      Boolean   @default(false)
  seasonType String?
  gradientConfig  Json
  particleConfig  Json?
  animationConfig Json?
  unlockLevel     Int       @default(1)
  unlockCondition String?
  goldCost        Int?
  diamondCost     Int?
  vipOnly         Boolean   @default(false)
  isActive        Boolean   @default(true)
  availableFrom   DateTime?
  availableUntil  DateTime?
  createdAt       DateTime  @default(now())

  @@index([isSeasonal, seasonType])
  @@index([type, rarity])
  @@index([isActive, availableFrom, availableUntil])
  @@map("theme_packs")
}

model UserThemeSettings {
  id                String    @id @default(cuid())
  userId            String    @unique
  autoSeasonalTheme Boolean   @default(false)
  preferredThemeId  String?
  lastAutoSwitchAt  DateTime?
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_theme_settings")
}

model Archetype {
  key          String   @id // v0.26.6 - Unique key (warrior, thinker, trickster, etc.)
  name         String
  description  String
  baseStats    Json // v0.26.6 - Base stat distribution { str:10, int:8, cha:6, luck:4 }
  growthRates  Json // v0.26.6 - Per-level stat growth { str:2, int:1, cha:1, luck:0.5 }
  emoji        String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  fusionWith   String[]
  fusionResult String?
  fusionCost   Int      @default(500)
  fusionVisual Json?

  @@map("archetypes")
}

model UserArchetypeFusion {
  id        String   @id @default(cuid())
  userId    String
  baseA     String
  baseB     String
  result    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@map("user_archetype_fusions")
}

model UserArchetypeHistory {
  id           String   @id @default(cuid())
  userId       String
  previousType String?
  newType String?
  reason       String
  statSnapshot Json?
  xpBonus      Int      @default(50)
  evolvedAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, evolvedAt])
  @@map("user_archetype_history")
}

model AvatarLayer {
  id              String           @id @default(cuid())
  layerType String?
  name            String
  description String?
  region          String?
  rarity          String
  unlockLevel     Int              @default(1)
  unlockCondition String?
  goldCost        Int?
  diamondCost     Int?
  imageUrl        String?
  zIndex          Int              @default(0)
  createdAt       DateTime         @default(now())
  userItems       UserAvatarItem[]

  @@index([layerType, rarity])
  @@map("avatar_layers")
}

model UserAvatarItem {
  id         String      @id @default(cuid())
  userId     String
  layerId    String
  unlockedAt DateTime    @default(now())
  layer      AvatarLayer @relation(fields: [layerId], references: [id], onDelete: Cascade)
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, layerId])
  @@index([userId])
  @@map("user_avatar_items")
}

model UserAvatar {
  id             String   @id @default(cuid())
  userId         String   @unique
  equippedLayers Json
  presetName     String?
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_avatars")
}

model DuelSpectator {
  id        String    @id @default(cuid())
  duelId    String
  userId    String
  joinedAt  DateTime  @default(now())
  reactedAt DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([duelId, userId])
  @@index([duelId])
  @@map("duel_spectators")
}

model DuelHighlight {
  id             String   @id @default(cuid())
  duelId         String
  initiatorName  String
  receiverName   String
  scoreDiff      Int
  finalScore     String
  category       String?
  isTopOfDay     Boolean  @default(false)
  viewCount      Int      @default(0)
  reactionsCount Int      @default(0)
  createdAt      DateTime @default(now())

  @@index([isTopOfDay, createdAt])
  @@index([createdAt])
  @@map("duel_highlights")
}

model CoopMission {
  id           String         @id @default(cuid())
  type String?
  title        String
  description String?
  region          String?
  questionIds  String[]
  minMembers   Int            @default(2)
  maxMembers   Int            @default(3)
  rewardXp     Int            @default(150)
  rewardGold   Int            @default(100)
  timeLimit    Int            @default(24)
  requiresSync Boolean        @default(true)
  status       String         @default("open")
  createdBy    String
  startedAt    DateTime?
  completedAt  DateTime?
  expiresAt    DateTime?
  createdAt    DateTime       @default(now())
  members      CoopMember[]
  progress     CoopProgress[]

  @@index([status, createdAt])
  @@map("coop_missions")
}

model CoopMember {
  id        String      @id @default(cuid())
  missionId String
  userId    String
  role      String      @default("member")
  joinedAt  DateTime    @default(now())
  isReady   Boolean     @default(false)
  mission   CoopMission @relation(fields: [missionId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([missionId, userId])
  @@index([missionId])
  @@map("coop_members")
}

model CoopProgress {
  id          String      @id @default(cuid())
  missionId   String
  questionId  String
  userId      String
  answer      String?
  confirmed   Boolean     @default(false)
  submittedAt DateTime?
  mission     CoopMission @relation(fields: [missionId], references: [id], onDelete: Cascade)

  @@unique([missionId, questionId, userId])
  @@index([missionId, confirmed])
  @@map("coop_progress")
}

model TotemBattle {
  id           String              @id @default(cuid())
  weekNumber   Int
  year         Int
  groupAId     String
  groupBId     String
  phase        String              @default("preparation")
  scoreA       Int                 @default(0)
  scoreB       Int                 @default(0)
  winnerId     String?
  startAt      DateTime
  endAt        DateTime
  rewardEmblem String?
  rewardXp     Int                 @default(500)
  createdAt    DateTime            @default(now())
  results      TotemBattleResult[]

  @@unique([weekNumber, year, groupAId, groupBId])
  @@index([phase, startAt])
  @@map("totem_battles")
}

model TotemBattleResult {
  id                  String      @id @default(cuid())
  battleId            String
  groupId             String
  finalScore          Int
  memberCount         Int
  avgLevel            Float
  xpGained            Int
  challengesCompleted Int
  ranking             Int
  rewardsJson         Json?
  createdAt           DateTime    @default(now())
  battle              TotemBattle @relation(fields: [battleId], references: [id], onDelete: Cascade)

  @@index([battleId])
  @@map("totem_battle_results")
}

model GroupMember {
  id       String   @id @default(cuid())
  userId   String
  groupId  String
  role     String   @default("member")
  joinedAt DateTime @default(now())
  group    Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@index([groupId])
  @@index([groupId, userId])
  @@map("group_members")
}

model GroupActivity {
  id        String   @id @default(cuid())
  groupId   String
  userId    String?
  type String?
  message   String
  metadata  Json?
  createdAt DateTime @default(now())
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId, createdAt])
  @@map("group_activities")
}

model Flow {
  id          String         @id @default(cuid())
  name        String
  description String?
  region          String?
  createdAt   DateTime       @default(now())
  metadata    Json?
  progresses  FlowProgress[]
  steps       FlowStep[]

  @@map("flows")
}

model FlowStep {
  id                String          @id @default(cuid())
  flowId            String
  questionVersionId String
  order             Int
  section           String?
  branchCondition   Json?
  randomGroup       String?
  isOptional        Boolean         @default(false)
  metadata          Json?
  answers           Answer[]
  progresses        FlowProgress[]
  fromLinks         FlowStepLink[]  @relation("FromStep")
  toLinks           FlowStepLink[]  @relation("ToStep")
  flow              Flow            @relation(fields: [flowId], references: [id])
  questionVersion   QuestionVersion @relation(fields: [questionVersionId], references: [id])

  @@map("flow_steps")
}

model FlowStepLink {
  id         String   @id @default(cuid())
  fromStepId String
  toStepId   String
  condition  Json?
  fromStep   FlowStep @relation("FromStep", fields: [fromStepId], references: [id])
  toStep     FlowStep @relation("ToStep", fields: [toStepId], references: [id])

  @@map("flow_step_links")
}

model FlowProgress {
  id            String    @id @default(cuid())
  userId        String
  flowId        String
  currentStepId String?
  startedAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  completedAt   DateTime?
  answers       Answer[]
  currentStep   FlowStep? @relation(fields: [currentStepId], references: [id])
  flow          Flow      @relation(fields: [flowId], references: [id])

  @@map("flow_progress")
}

model Answer {
  id                String          @id @default(cuid())
  sessionId         String
  stepId            String
  questionVersionId String
  value             String
  createdAt         DateTime        @default(now())
  questionVersion   QuestionVersion @relation(fields: [questionVersionId], references: [id])
  session           FlowProgress    @relation(fields: [sessionId], references: [id])
  step              FlowStep        @relation(fields: [stepId], references: [id])

  @@map("answers")
}

model Language {
  id              String           @id @default(cuid())
  code            String           @unique
  name            String
  userSubmissions UserSubmission[]

  @@map("languages")
}

model Version {
  id        String   @id @default(cuid())
  name      String
  value     String
  createdAt DateTime @default(now())

  @@map("versions")
}

model Category {
  id              String           @id @default(cuid())
  name            String
  subCategories   SubCategory[]
  userSubmissions UserSubmission[]
}

model SubCategory {
  id         String           @id @default(cuid())
  name       String
  categoryId String
  category   Category         @relation(fields: [categoryId], references: [id])
  subSubs    SubSubCategory[]
}

model SubSubCategory {
  id            String        @id @default(cuid())
  name          String
  subCategoryId String
  sssCategories SssCategory[]
  subCategory   SubCategory   @relation(fields: [subCategoryId], references: [id])
}

model SssCategory {
  id               String               @id @default(cuid())
  name             String
  subSubCategoryId String
  status           String               @default("pending")
  generatedAt      DateTime?
  error            String?
  review           String?
  finalText        String?
  responseType String?
  outcome          String?
  multiplication   Int?
  difficulty       String?
  ageCategory      String?
  gender           String?
  author           String?
  wildcard         String?
  subSubCategory   SubSubCategory       @relation(fields: [subSubCategoryId], references: [id])
  flowQuestions    FlowQuestion[]       @relation("FlowQuestions")
  generationJobs   GenerationJob[]
  generationLogs   QuestionGeneration[] @relation("QuestionGenerationLogs")
  questions        Question[]           @relation("SsscQuestions")
}

model UserQuestion {
  id                 String            @id @default(cuid())
  userId             String
  questionId         String?
  questionTemplateId String? // v0.29.24 - Reference to QuestionTemplate
  status             String            @default("answered")
  servedAt           DateTime          @default(now()) // v0.29.24 - When question was served
  answeredAt         DateTime? // v0.29.24 - When question was answered
  archetypeContext   String? // v0.29.24 - User archetype at time of serving
  moodContext        String? // v0.29.24 - World mood at time of serving
  seasonId           String? // v0.29.24 - Season association
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  question           Question?         @relation(fields: [questionId], references: [id], onDelete: SetNull)
  questionTemplate   QuestionTemplate? @relation(fields: [questionTemplateId], references: [id], onDelete: SetNull) // v0.29.24
  user               User              @relation(fields: [userId], references: [id])

  @@unique([userId, questionId])
  @@index([userId, servedAt(sort: Desc)]) // v0.29.24 - DB Optimization composite index
}

// Question Template model (v0.29.24)
model QuestionTemplate {
  id                String                   @id @default(cuid())
  category          QuestionTemplateCategory // daily|weekly|archetype|event|wildcard
  archetypeAffinity ArchetypeAffinity? // v0.29.24 - Optional archetype match
  tone              QuestionTone // serious|poetic|chaotic|funny
  text              String                   @db.Text
  tags              String[]                 @default([])
  weight            Float                    @default(1.0) // Priority weight for selection
  isActive          Boolean                  @default(true)
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  userQuestions     UserQuestion[] // v0.29.24 - Questions served to users

  @@index([category, isActive])
  @@index([archetypeAffinity, isActive])
  @@index([tone, isActive])
  @@index([weight])
  @@map("question_templates")
}

// Battle Achievement model (v0.29.25)
model BattleAchievement {
  id             String                      @id @default(cuid())
  key            String                      @unique
  title          String
  description    String                      @db.Text
  triggerType    BattleAchievementTriggerType // duelWin|duelLose|missionComplete|event
  thresholdValue Int                         @default(1) // e.g., 5 wins, 10 missions
  rewardXP       Int                         @default(0)
  rewardBadgeId  String?                     // Optional badge reward
  rarity         BattleAchievementRarity     @default(common)
  isActive       Boolean                     @default(true)
  createdAt      DateTime                    @default(now())
  updatedAt      DateTime                    @updatedAt
  userProgress   UserBattleAchievement[]     // v0.29.25 - User progress tracking

  @@index([triggerType, isActive])
  @@index([rarity, isActive])
  @@index([thresholdValue])
  @@map("battle_achievements")
}

// User Battle Achievement progress model (v0.29.25)
model UserBattleAchievement {
  id           String            @id @default(cuid())
  userId       String
  achievementId String
  progress     Int               @default(0)
  isUnlocked   Boolean           @default(false)
  isClaimed    Boolean           @default(false)
  unlockedAt   DateTime?
  claimedAt    DateTime?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  achievement  BattleAchievement  @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId, isUnlocked])
  @@index([userId, isClaimed])
  @@index([achievementId])
  @@map("user_battle_achievements")
}

model Group {
  id           String          @id @default(cuid())
  name         String          @unique
  emblem       String?         @default("ðŸ”¥")
  motto        String?
  ownerId      String?
  description String?
  region          String?
  visibility   String          @default("private")
  transparency String          @default("summary")
  maxMembers   Int             @default(10)
  totalXp      Int             @default(0)
  avgKarma     Int             @default(0)
  avgPrestige  Int             @default(0)
  cost         Int             @default(100)
  weeklyBonus  Boolean         @default(false)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  members      UserGroup[]
  activities   GroupActivity[]
  groupMembers GroupMember[]
  stats        GroupStat[]

  @@index([visibility, createdAt(sort: Desc)])
  @@map("groups")
}

model GroupStat {
  id          String   @id @default(cuid())
  groupId     String
  totalXP     Int      @default(0)
  reflections Int      @default(0)
  avgLevel    Int      @default(0)
  updatedAt   DateTime @default(now())
  group       Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId, updatedAt])
  @@map("group_stats")
}

model UserGroup {
  id      String @id @default(cuid())
  userId  String
  groupId String
  group   Group  @relation(fields: [groupId], references: [id])
  user    User   @relation(fields: [userId], references: [id])

  @@unique([userId, groupId])
  @@index([groupId])
}

model PublicPoll {
  id            String         @id @default(cuid())
  title         String
  question      String
  options       String[]
  region        String?
  visibility    String         @default("public")
  creatorId     String
  allowFreetext Boolean        @default(false)
  premiumCost   Int            @default(0)
  rewardXP      Int            @default(50)
  createdAt     DateTime       @default(now())
  expiresAt     DateTime?
  responses     PollResponse[]

  @@index([region, createdAt])
  @@map("public_polls")
}

model PollResponse {
  id        String     @id @default(cuid())
  pollId    String
  userId    String
  optionIdx Int?
  freetext  String?
  region    String?
  createdAt DateTime   @default(now())
  poll      PublicPoll @relation(fields: [pollId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([pollId, userId])
  @@map("poll_responses")
}

model PublicChallenge {
  id          String    @id @default(cuid())
  title       String
  description String
  region      String?
  rewardXP    Int       @default(100)
  rewardItem  String?
  activeFrom  DateTime  @default(now())
  activeTo    DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())

  @@index([region, createdAt])
  @@map("public_challenges")
}

model ContentPack {
  id          String     @id @default(cuid())
  key         String     @unique
  title       String
  description String?
  region          String?
  category    String?
  price       Int        @default(0)
  premiumOnly Boolean    @default(false)
  isActive    Boolean    @default(true)
  themeColor  String?
  icon        String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  items       PackItem[]
  userPacks   UserPack[]

  @@index([category, isActive])
  @@map("content_packs")
}

model PackItem {
  id        String      @id @default(cuid())
  packId    String
  type String?
  refId     String?
  data      Json?
  createdAt DateTime    @default(now())
  pack      ContentPack @relation(fields: [packId], references: [id], onDelete: Cascade)

  @@index([packId])
  @@map("pack_items")
}

model UserPack {
  id         String      @id @default(cuid())
  userId     String
  packId     String
  unlockedAt DateTime    @default(now())
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  pack       ContentPack @relation(fields: [packId], references: [id], onDelete: Cascade)

  @@unique([userId, packId])
  @@index([packId])
  @@map("user_packs")
}

model Fireside {
  id             String             @id @default(cuid())
  title          String?
  creatorId      String
  participantIds String[]
  expiresAt      DateTime
  isActive       Boolean            @default(true)
  createdAt      DateTime           @default(now())
  reactions      FiresideReaction[]

  @@index([isActive, expiresAt])
  @@map("firesides")
}

model FiresideReaction {
  id         String   @id @default(cuid())
  firesideId String
  userId     String
  emoji      String
  createdAt  DateTime @default(now())
  fireside   Fireside @relation(fields: [firesideId], references: [id], onDelete: Cascade)

  @@index([firesideId, userId])
  @@map("fireside_reactions")
}

model MemoryJournal {
  id          String   @id @default(cuid())
  userId      String
  title       String
  summary     String?
  content     String
  periodStart DateTime
  periodEnd   DateTime
  sourceCount Int      @default(0)
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@map("memory_journals")
}

model ComparisonCard {
  id            String   @id @default(cuid())
  userId        String
  statsJson     Json
  funText       String
  imageUrl      String
  generatedAt   DateTime @default(now())
  autoGenerated Boolean  @default(false)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, generatedAt(sort: Desc)])
  @@map("comparison_cards")
}

model MicroMission {
  id              String             @id @default(cuid())
  key             String             @unique
  title           String
  description     String
  type String? // 'solo' | 'coop'
  rarity          String // 'common' | 'rare' | 'unique'
  durationSec     Int                @default(300)
  rewardXP        Int                @default(0)
  rewardItem      String?
  rewardGold      Int?
  skipCostFood    Int?
  skipCostGold    Int?
  skipCostPremium Int?
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  userMissions    UserMicroMission[]

  @@index([isActive, rarity])
  @@map("micro_missions")
}

model UserMicroMission {
  id          String       @id @default(cuid())
  userId      String
  missionId   String
  status      String // 'active' | 'completed' | 'skipped' | 'expired'
  startedAt   DateTime     @default(now())
  completedAt DateTime?
  mission     MicroMission @relation(fields: [missionId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@map("user_micro_missions")
}

model AvatarMood {
  id           String   @id @default(cuid())
  userId       String
  mood         String // 'neutral' | 'happy' | 'sad' | 'angry' | 'excited' | 'tired' | 'focused'
  pose         String // 'default' | 'thinking' | 'celebrating' | 'resting'
  emotionScore Float    @default(0)
  source       String // 'manual' | 'auto'
  updatedAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("avatar_moods")
}

// Global Mood model (v0.29.26)
model GlobalMood {
  id             String           @id @default(cuid())
  calmScore      Float            @default(0)
  chaosScore     Float            @default(0)
  neutralScore   Float            @default(0)
  updatedAt      DateTime        @default(now()) @updatedAt
  dominantMood   GlobalMoodType  @default(neutral)
  worldModifier  Json?           // JSON with active buffs/debuffs

  @@map("global_mood")
}

// User Mood Log model (v0.29.26)
model UserMoodLog {
  id           String          @id @default(cuid())
  userId       String
  reflectionId String?         // Optional reference to reflection
  mood         GlobalMoodType  // calm|chaos|neutral
  loggedAt     DateTime        @default(now())
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  reflection   UserReflection? @relation(fields: [reflectionId], references: [id], onDelete: SetNull)

  @@index([userId, loggedAt(sort: Desc)])
  @@index([mood, loggedAt])
  @@index([loggedAt])
  @@map("user_mood_logs")
}

model MoodPreset {
  key         String   @id
  title       String
  description String?
  region          String?
  toneProfile Json?
  createdAt   DateTime @default(now())
  isActive    Boolean  @default(true)

  @@map("mood_presets")
}

model MentorNPC {
  id                String       @id @default(cuid())
  key               String       @unique
  name              String
  archetypeAffinity String[]
  personality       String // 'analyst' | 'bard' | 'sage' | 'trickster' | 'guardian' | 'healer' | 'hacker'
  introText         String?
  tips              String[]
  voiceTone         String // 'calm' | 'chaotic' | 'wise' | 'sarcastic'
  isActive          Boolean      @default(true)
  createdAt         DateTime     @default(now())
  userMentors       UserMentor[]

  @@map("mentor_npcs")
}

model UserMentor {
  id                String    @id @default(cuid())
  userId            String
  mentorId          String
  affinityScore     Float     @default(0)
  lastInteractionAt DateTime  @default(now())
  mentor            MentorNPC @relation(fields: [mentorId], references: [id], onDelete: Cascade)
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, mentorId])
  @@index([userId, mentorId])
  @@map("user_mentors")
}

model SeasonStoryline {
  id            String                 @id @default(cuid())
  key           String                 @unique
  title         String
  description   String
  startDate     DateTime
  endDate       DateTime?
  isActive      Boolean                @default(false)
  xpBonus       Float?
  goldBonus     Float?
  eventModifier Json?
  npcIds        String[]
  themeColor    String?
  posterUrl     String?
  createdAt     DateTime               @default(now())
  achievements  StorylineAchievement[]

  @@index([isActive])
  @@index([startDate(sort: Desc)])
  @@map("season_storylines")
}

model StorylineAchievement {
  id          String          @id @default(cuid())
  seasonId    String
  title       String
  description String
  rewardItem  String?
  rewardXP    Int?
  createdAt   DateTime        @default(now())
  season      SeasonStoryline @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  @@index([seasonId])
  @@map("storyline_achievements")
}

model Wallet {
  id                 String        @id @default(cuid())
  userId             String        @unique
  tenantId           String
  funds              Decimal       @default(0)
  diamonds           Int           @default(0)
  badgesClaimedCount Int           @default(0) // v0.29.0 - Count of badges claimed
  ledgerEntries      LedgerEntry[]
  user               User          @relation(fields: [userId], references: [id])

  @@unique([userId, tenantId])
  @@index([tenantId])
}

model LedgerEntry {
  id         String     @id @default(cuid())
  walletId   String
  tenantId   String
  kind       LedgerKind
  amount     Int
  currency   Currency   @relation(fields: [currencyId], references: [id])
  refType String?
  refId      String?
  note       String?
  createdAt  DateTime   @default(now())
  wallet     Wallet     @relation(fields: [walletId], references: [id])
  currencyId String

  @@index([tenantId])
  @@index([walletId, createdAt])
}

model Product {
  id              String        @id @default(cuid())
  slug            String        @unique
  title           String
  description String?
  region          String?
  kind            ProductKind
  payload         Json
  stackable       Boolean       @default(false)
  active          Boolean       @default(true)
  createdAt       DateTime      @default(now())
  entitlements    Entitlement[]
  prices          Price[]
  purchases       Purchase[]
  avatarEquip     UserProfile[] @relation("avatarEquip")
  backgroundEquip UserProfile[] @relation("backgroundEquip")
  skinEquip       UserProfile[] @relation("skinEquip")
}

model Price {
  id            String  @id @default(cuid())
  productId     String
  stripePriceId String?
  currencyCode  String
  unitAmount    Int
  active        Boolean @default(true)
  product       Product @relation(fields: [productId], references: [id])

  @@index([productId])
}

model Purchase {
  id         String         @id @default(cuid())
  userId     String
  tenantId   String
  productId  String
  quantity   Int            @default(1)
  totalMinor Int
  status     PurchaseStatus @default(SUCCEEDED)
  extRef     String?
  createdAt  DateTime       @default(now())
  product    Product        @relation(fields: [productId], references: [id])
  user       User           @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId, createdAt])
}

model Entitlement {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String
  productId String
  meta      Json?
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, productId])
  @@index([tenantId])
}

model Subscription {
  id               String   @id @default(cuid())
  userId           String
  stripeSubId      String   @unique
  plan             String
  status           String
  currentPeriodEnd DateTime
  perks            Json
  createdAt        DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id])
}

model UserProfile {
  id                   String   @id @default(cuid())
  userId               String   @unique
  equippedAvatarId     String?
  equippedBackgroundId String?
  equippedSkinId       String?
  updatedAt            DateTime @updatedAt
  equippedAvatar       Product? @relation("avatarEquip", fields: [equippedAvatarId], references: [id])
  equippedBackground   Product? @relation("backgroundEquip", fields: [equippedBackgroundId], references: [id])
  equippedSkin         Product? @relation("skinEquip", fields: [equippedSkinId], references: [id])
  user                 User     @relation(fields: [userId], references: [id])
}

model Badge {
  id               String           @id @default(cuid())
  key              String           @unique // v0.29.0 - Badge key identifier
  name             String // v0.29.0 - Display name
  description      String
  icon             String
  rarity           BadgeRarity // v0.29.0 - Badge rarity enum
  unlockType       BadgeUnlockType // v0.29.0 - How badge is unlocked
  requirementValue String? // v0.29.0 - XP amount, event key, etc.
  rewardType       BadgeRewardType? // v0.29.0 - Type of reward granted
  rewardValue      String? // v0.29.0 - Reward amount or identifier
  seasonId         String? // v0.29.0 - Optional season association
  isActive         Boolean          @default(true) // v0.29.0 - Active flag
  createdAt        DateTime         @default(now())

  // Legacy fields (keeping for backward compatibility)
  slug       String?     @unique
  title      String?
  active     Boolean?    @default(true)
  rarityId   String?
  rarityTier RarityTier? @relation(fields: [rarityId], references: [id], onDelete: SetNull)

  season     Season?     @relation(fields: [seasonId], references: [id], onDelete: SetNull)
  userBadges UserBadge[]

  @@index([rarity])
  @@index([unlockType])
  @@index([isActive])
  @@index([seasonId])
}

model UserBadge {
  id         String    @id @default(cuid())
  userId     String
  badgeId    String
  unlockedAt DateTime  @default(now()) // v0.29.0 - When badge was unlocked
  claimedAt  DateTime? // v0.29.0 - When reward was claimed
  isClaimed  Boolean   @default(false) // v0.29.0 - Claim status
  badge      Badge     @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Legacy field
  createdAt DateTime? @default(now())

  @@unique([userId, badgeId])
  @@index([userId, isClaimed])
  @@index([badgeId])
}

model FailedLoginAttempt {
  id        String   @id @default(cuid())
  ipAddress String
  email     String
  createdAt DateTime @default(now())

  @@index([ipAddress, createdAt])
  @@index([email, createdAt])
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
}

model EmailVerify {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  ip        String
  action    String
  meta      Json?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@map("audit_logs")
}

model GenerationBatch {
  id          String          @id @default(cuid())
  createdAt   DateTime        @default(now())
  startedAt   DateTime?
  finishedAt  DateTime?
  status      BatchStatus     @default(PENDING)
  language    String
  targetCount Int
  processed   Int             @default(0)
  succeeded   Int             @default(0)
  failed      Int             @default(0)
  note        String?
  jobs        GenerationJob[]

  @@index([status, language])
  @@map("generation_batches")
}

model GenerationJob {
  id              String          @id @default(cuid())
  createdAt       DateTime        @default(now())
  startedAt       DateTime?
  finishedAt      DateTime?
  status          JobStatus       @default(PENDING)
  error           String?
  language        String
  sssCategoryId   String
  batchId         String
  aiLogId         String?
  moderatorNotes  String?
  moderatorScore  Float?
  moderatorStatus String?
  moderatorUserId String?
  qualityScore    Float?
  retryCount      Int             @default(0)
  weightScore     Float?
  aiLog           AIResponseLog?  @relation(fields: [aiLogId], references: [id])
  batch           GenerationBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  sssCategory     SssCategory     @relation(fields: [sssCategoryId], references: [id])

  @@index([status, language, sssCategoryId])
  @@index([moderatorStatus])
  @@map("generation_jobs")
}

model AIResponseLog {
  id        String          @id @default(cuid())
  createdAt DateTime        @default(now())
  prompt    String
  response  String
  tokensIn  Int?
  tokensOut Int?
  model     String?
  jobs      GenerationJob[]

  @@map("ai_response_logs")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type String?
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model UserSubmission {
  id            String           @id @default(cuid())
  userId        String
  type          SubmissionType   @default(QUESTION)
  status        SubmissionStatus @default(PENDING)
  title         String
  content       String
  description String?
  region          String?
  categoryId    String?
  languageId    String?
  tags          String[]
  imageUrl      String?
  metadata      Json?
  upvotes       Int              @default(0)
  downvotes     Int              @default(0)
  score         Int              @default(0)
  moderatorId   String?
  moderatorNote String?
  reviewedAt    DateTime?
  approvedAt    DateTime?
  rejectedAt    DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  user          User             @relation("UserSubmissions", fields: [userId], references: [id], onDelete: Cascade)
  moderator     User?            @relation("ModeratedSubmissions", fields: [moderatorId], references: [id])
  category      Category?        @relation(fields: [categoryId], references: [id])
  language      Language?        @relation(fields: [languageId], references: [id])
  votes         Vote[]

  @@index([userId])
  @@index([status])
  @@index([categoryId])
  @@index([createdAt])
  @@map("user_submissions")
}

model Event {
  id             String            @id @default(cuid())
  title          String
  description    String
  type           EventType         @default(CHALLENGE)
  status         EventStatus       @default(DRAFT)
  startDate      DateTime
  endDate        DateTime
  rewardXP       Int               @default(0)
  rewardDiamonds Int               @default(0)
  imageUrl       String?
  metadata       Json?
  participants   Int               @default(0)
  creatorId      String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  creator        User?             @relation("CreatedEvents", fields: [creatorId], references: [id])
  // Locale code (v0.27.1)
  localeCode     String?           @default("global")
  // Moderation (v0.27.6)
  isFlagged      Boolean           @default(false)
  flagReason     String?
  visibility     ContentVisibility @default(PUBLIC)

  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([localeCode])
  @@index([visibility])
  @@map("events")
}

model Vote {
  id           String         @id @default(cuid())
  userId       String?
  sessionId    String?
  submissionId String
  voteType     VoteType
  createdAt    DateTime       @default(now())
  user         User?          @relation("UserVotes", fields: [userId], references: [id], onDelete: Cascade)
  submission   UserSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([userId, submissionId])
  @@unique([sessionId, submissionId])
  @@index([submissionId])
  @@map("votes")
}

model Season {
  id          String          @id @default(cuid())
  name        String
  displayName String
  number      Int             @unique
  startDate   DateTime
  endDate     DateTime
  status      SeasonStatus    @default(UPCOMING)
  metadata    Json?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  archives    SeasonArchive[]
  badges      Badge[] // v0.29.0 - Badges associated with this season
  chronicles  Chronicle[] // v0.29.1 - Chronicles associated with this season

  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@map("seasons")
}

model SeasonArchive {
  id           String   @id @default(cuid())
  userId       String
  seasonId     String
  finalXP      Int      @default(0)
  finalCoins   Int      @default(0)
  finalRank    Int?
  finalKarma   Int      @default(0)
  achievements Json?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  season       Season   @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  @@unique([userId, seasonId])
  @@index([seasonId])
  @@index([userId])
  @@map("season_archives")
}

model CosmeticItem {
  id          String         @id @default(cuid())
  slug        String         @unique
  name        String
  description String?
  region          String?
  type        CosmeticType
  rarity      CosmeticRarity @default(COMMON)
  price       Int            @default(0)
  imageUrl    String?
  metadata    Json?
  active      Boolean        @default(true)
  seasonOnly  Boolean        @default(false)
  seasonId    String?
  createdAt   DateTime       @default(now())
  userItems   UserCosmetic[]
  rarityId    String?
  rarityTier  RarityTier?    @relation(fields: [rarityId], references: [id], onDelete: SetNull)

  @@index([type])
  @@index([active])
  @@index([rarityId])
  @@map("cosmetic_items")
}

model UserCosmetic {
  id          String       @id @default(cuid())
  userId      String
  cosmeticId  String
  equipped    Boolean      @default(false)
  purchasedAt DateTime     @default(now())
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  cosmetic    CosmeticItem @relation(fields: [cosmeticId], references: [id], onDelete: Cascade)

  @@unique([userId, cosmeticId])
  @@index([userId])
  @@index([equipped])
  @@map("user_cosmetics")
}

model SeasonalEvent {
  id          String              @id @default(cuid())
  title       String
  description String
  startDate   DateTime
  endDate     DateTime
  bonusType String?
  bonusValue  Int                 @default(0)
  status      SeasonalEventStatus @default(INACTIVE)
  metadata    Json?
  createdAt   DateTime            @default(now())

  @@index([status])
  @@index([startDate])
  @@map("seasonal_events")
}

// v0.29.12 - Mirror Events: Global synchronous reflection weeks
model MirrorEvent {
  id            String           @id @default(cuid())
  key           String           @unique
  title         String
  description   String
  theme         String? // Visual theme key
  startDate     DateTime
  endDate       DateTime
  active        Boolean          @default(false)
  questionSet   String[]         @default([]) // Array of reflection questions
  rewardXP      Int              @default(0)
  rewardBadgeId String?
  createdAt     DateTime         @default(now())
  reflections   UserReflection[]

  @@index([active])
  @@index([startDate])
  @@index([endDate])
  @@map("mirror_events")
}

// v0.29.13 - Wildcard Events: Random humor engine
model WildcardEvent {
  id            String              @id @default(cuid())
  title         String
  description   String
  triggerType String? // 'xpGain' | 'login' | 'reflection' | 'random'
  rewardXP      Int                 @default(0)
  rewardKarma   Int                 @default(0)
  flavorText    String
  createdAt     DateTime            @default(now())
  userWildcards UserWildcardEvent[]

  @@index([triggerType])
  @@map("wildcard_events")
}

// User wildcard event tracking (prevent duplicates, track daily limits)
model UserWildcardEvent {
  id         String        @id @default(cuid())
  userId     String
  wildcardId String
  redeemed   Boolean       @default(false)
  redeemedAt DateTime?
  createdAt  DateTime      @default(now())
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  wildcard   WildcardEvent @relation(fields: [wildcardId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, redeemed])
  @@map("user_wildcard_events")
}

// v0.29.15 - Share Cards: Shareable reflections & summaries
model ShareCard {
  id        String   @id @default(cuid())
  userId    String
  type String? // 'weekly' | 'achievement' | 'comparison'
  imageUrl  String?
  caption   String?
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([expiresAt])
  @@map("share_cards")
}

// Poster Card model (v0.29.28)
model PosterCard {
  id        String   @id @default(cuid())
  userId    String
  title     String
  statsJson Json     // Archetype, level, mood, XP, reflection count, etc.
  imageUrl  String?  // Generated poster image URL
  isShared  Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([isShared, createdAt(sort: Desc)])
  @@index([createdAt])
  @@map("poster_cards")
}

// v0.29.16 - Dreamspace: Surreal challenge layer
model DreamEvent {
  id          String           @id @default(cuid())
  title       String
  description String
  triggerType String? // 'sleep' | 'reflection' | 'random'
  effect      Json // XP shift, mood change, karma flux
  flavorTone  String // 'calm' | 'chaotic' | 'mystic'
  createdAt   DateTime         @default(now())
  isActive    Boolean          @default(true)
  userDreams  UserDreamEvent[]

  @@index([isActive])
  @@index([triggerType])
  @@index([flavorTone])
  @@map("dream_events")
}

// User dream event tracking
model UserDreamEvent {
  id         String     @id @default(cuid())
  userId     String
  dreamId    String
  resolved   Boolean    @default(false)
  resolvedAt DateTime?
  createdAt  DateTime   @default(now())
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  dream      DreamEvent @relation(fields: [dreamId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, resolved])
  @@map("user_dream_events")
}

// v0.29.17 - Generation Records: Inheritance layer
model GenerationRecord {
  id               String   @id @default(cuid())
  userId           String
  generationNumber Int
  prestigeId       String? // Link to prestige that triggered this generation
  inheritedPerks   Json     @default("[]") // Array of inherited perks (e.g., [{ type: 'xpBoost', value: 2 }, { type: 'title', value: 'Echo' }])
  summaryText      String? // Summary text from Lore Engine
  createdAt        DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, generationNumber])
  @@index([userId, createdAt])
  @@map("generation_records")
}

// v0.29.19 - Feedback: User feedback and bug reports
model Feedback {
  id            String         @id @default(cuid())
  userId        String?
  message       String         @db.Text
  screenshotUrl String?
  context       String? // Additional context (page, action, etc.)
  status        FeedbackStatus @default(NEW)
  createdAt     DateTime       @default(now())
  reviewedAt    DateTime?
  reviewedBy    String?
  user          User?          @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([createdAt])
  @@index([userId])
  @@map("feedback")
}

enum FeedbackStatus {
  NEW
  REVIEWED
  RESOLVED
}

// v0.29.19 - Creator Packs: Community-created content
// v0.29.27 - Extended with publish & reward fields
model CreatorPack {
  id             String            @id @default(cuid())
  creatorId      String
  title          String
  description String?
  region          String?           @db.Text
  type           CreatorPackType   @default(POLL)
  status         CreatorPackStatus @default(DRAFT)
  metadata       Json? // Additional pack data (questions, rewards, etc.)
  createdAt      DateTime          @default(now())
  approvedAt     DateTime?
  approvedBy     String?
  // v0.29.27 - Publish & reward fields
  rewardType     CreatorRewardType? // xp|gold|diamonds|badge
  rewardValue    Int?               @default(0)
  publishedAt    DateTime?
  downloadsCount Int                @default(0)
  user           User               @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  userCreated    UserCreatedPack[] // v0.29.27 - User pack usage tracking

  @@index([status])
  @@index([creatorId])
  @@index([type])
  @@index([createdAt])
  @@index([publishedAt])
  @@index([downloadsCount])
  @@map("creator_packs")
}

enum CreatorPackType {
  POLL
  REFLECTION
  MISSION
}

enum CreatorPackStatus {
  DRAFT
  APPROVED
  REJECTED
}

// Creator reward type enum (v0.29.27)
enum CreatorRewardType {
  xp
  gold
  diamonds
  badge
}

// User Created Pack model (v0.29.27)
model UserCreatedPack {
  id            String       @id @default(cuid())
  userId        String
  packId        String
  isPublished   Boolean      @default(false)
  earnedRewards Int          @default(0) // Total rewards earned from this pack
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  pack          CreatorPack  @relation(fields: [packId], references: [id], onDelete: Cascade)

  @@unique([userId, packId])
  @@index([userId, isPublished])
  @@index([packId])
  @@index([createdAt])
  @@map("user_created_packs")
}

// v0.29.20 - Item Recipes: Crafting recipes
model ItemRecipe {
  id           String   @id @default(cuid())
  itemId       String // The item this recipe produces
  ingredients  Json     @default("[]") // Array of { itemId, quantity } objects
  craftTime    Int      @default(3000) // Crafting time in milliseconds (default 3s)
  xpReward     Int      @default(10) // XP reward for crafting
  discoveredBy String? // User who discovered this recipe (null = default recipe)
  createdAt    DateTime @default(now())
  item         Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([discoveredBy])
  @@index([createdAt])
  @@map("item_recipes")
}

// v0.29.20 - Item Discoveries: User's discovered items
model ItemDiscovery {
  id           String   @id @default(cuid())
  userId       String
  itemId       String
  discoveredAt DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  item         Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([userId, itemId])
  @@index([userId])
  @@index([itemId])
  @@index([discoveredAt])
  @@map("item_discoveries")
}

model UserReflection {
  id            String                   @id @default(cuid())
  userId        String
  date          DateTime                 @default(now())
  type          ReflectionType           @default(DAILY)
  content       String
  summary       String?
  sentiment     String?                  @default("neutral")
  stats         Json?
  metadata      Json?
  mirrorEventId String? // v0.29.12 - Mirror Events linking
  createdAt     DateTime                 @default(now())
  user          User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  mirrorEvent   MirrorEvent?             @relation(fields: [mirrorEventId], references: [id], onDelete: SetNull) // v0.29.12 - Mirror Events
  conversations ReflectionConversation[] // v0.29.2 - AI conversations
  moodLogs      UserMoodLog[]            // v0.29.26 - Mood logs

  @@index([userId])
  @@index([date])
  @@index([type])
  @@index([mirrorEventId])
  @@index([userId, createdAt(sort: Desc)]) // v0.29.22 - DB Optimization composite index
  @@map("user_reflections")
}

// Reflection Conversation system (v0.29.2)
model ReflectionConversation {
  id           String         @id @default(cuid())
  userId       String
  reflectionId String
  prompt       String         @db.Text
  response     String         @db.Text
  toneLevel    Int // 1-5 from Roast/Toast meter
  modelUsed    String? // e.g., "gpt-4", "local", "fallback"
  createdAt    DateTime       @default(now())
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  reflection   UserReflection @relation(fields: [reflectionId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([reflectionId])
  @@index([createdAt])
  @@map("reflection_conversations")
}

// Unified stats model (v0.29.22 - Consolidated from weekly_stats)
model UserStats {
  id                String   @id @default(cuid())
  userId            String   @unique // Single unified record per user
  totalXP           Int      @default(0)
  totalCoins        Int      @default(0)
  totalKarma        Int      @default(0)
  questionsCount    Int      @default(0)
  streakDays        Int      @default(0)
  currentRank       Int?
  lastWeekXP        Int      @default(0) // Weekly tracking preserved
  lastWeekCoins     Int      @default(0)
  lastWeekKarma     Int      @default(0)
  lastWeekQuestions Int      @default(0)
  lastWeekStreak    Int      @default(0)
  rankChange        Int?
  metadata          Json?
  updatedAt         DateTime @default(now())
  createdAt         DateTime @default(now())
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([currentRank])
  @@map("user_stats")
}

// Deprecated: Use UserStats instead (v0.29.22)
// Kept for backward compatibility during migration
model UserWeeklyStats {
  id             String   @id @default(cuid())
  userId         String
  weekStart      DateTime
  weekEnd        DateTime
  xpGain         Int      @default(0)
  coinsGain      Int      @default(0)
  karmaGain      Int      @default(0)
  questionsCount Int      @default(0)
  streakDays     Int      @default(0)
  rankChange     Int?
  metadata       Json?
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekStart])
  @@index([userId])
  @@index([weekStart])
  @@map("user_weekly_stats")
}

// Chronicle system (v0.29.1)
model Chronicle {
  id          String        @id @default(cuid())
  userId      String
  type        ChronicleType // weekly or seasonal
  summaryText String        @db.Text
  statsJson   Json // Reflection count, XP, sentiment, etc.
  quote       String? // Optional motivational/funny quote
  generatedAt DateTime      @default(now())
  seasonId    String? // Optional season association for seasonal chronicles
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  season      Season?       @relation(fields: [seasonId], references: [id], onDelete: SetNull)

  @@index([userId, generatedAt(sort: Desc)]) // Quick access to latest
  @@index([type])
  @@index([seasonId])
  @@map("chronicles")
}

// Region system (v0.29.3)
model Region {
  id                     String                 @id @default(cuid())
  key                    String                 @unique
  name                   String
  description            String                 @db.Text
  orderIndex             Int                    @default(0) // Order for travel sequence
  buffType               RegionBuffType
  buffValue              Float // e.g., 0.05 for +5%
  unlockRequirementType  UnlockRequirementType? // Optional unlock requirement
  unlockRequirementValue String? // e.g., level "10", task "key_name", gold "1000"
  isActive               Boolean                @default(true)
  createdAt              DateTime               @default(now())
  userRegions            UserRegion[]

  @@index([orderIndex])
  @@index([isActive])
  @@map("regions")
}

model UserRegion {
  id           String    @id @default(cuid())
  userId       String
  regionId     String
  isUnlocked   Boolean   @default(false)
  visitedAt    DateTime?
  activeBuff   Boolean   @default(false) // Whether this region's buff is currently active
  lastTravelAt DateTime?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  region       Region    @relation(fields: [regionId], references: [id], onDelete: Cascade)

  @@unique([userId, regionId])
  @@index([userId, activeBuff])
  @@index([regionId])
  @@map("user_regions")
}

// Quest system (v0.29.4)
model Quest {
  id               String               @id @default(cuid())
  key              String               @unique
  title            String
  description      String               @db.Text
  type             QuestType // daily, weekly, story, side
  requirementType  QuestRequirementType
  requirementValue Int // e.g., 100 XP, 5 reflections, etc.
  rewardXP         Int                  @default(0)
  rewardGold       Int                  @default(0)
  rewardItem       String? // Item ID or key
  rewardBadge      String? // Badge key
  rewardKarma      Int                  @default(0)
  isRepeatable     Boolean              @default(false)
  isActive         Boolean              @default(true)
  createdAt        DateTime             @default(now())
  userQuests       UserQuest[]

  @@index([type, isActive])
  @@index([isActive])
  @@map("quests")
}

model UserQuest {
  id          String    @id @default(cuid())
  userId      String
  questId     String
  progress    Int       @default(0)
  isCompleted Boolean   @default(false)
  isClaimed   Boolean   @default(false)
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  quest       Quest     @relation(fields: [questId], references: [id], onDelete: Cascade)

  @@unique([userId, questId]) // v0.29.22 - Unique constraint
  @@index([userId, isCompleted, isClaimed]) // v0.29.22 - DB Optimization composite index (replaces separate indexes)
  @@index([questId])
  @@map("user_quests")
}

// Lore system (v0.29.5) - User-specific narrative logs
model UserLoreEntry {
  id         String         @id @default(cuid())
  userId     String
  sourceType LoreSourceType // reflection, quest, item, event, system
  sourceId   String? // Optional reference to source (reflectionId, questId, etc.)
  tone       LoreTone // serious, comedic, poetic
  text       String         @db.Text // Lore snippet (â‰¤ 300 chars)
  createdAt  DateTime       @default(now())
  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([sourceType])
  @@index([tone])
  @@map("user_lore_entries")
}

// Social system (v0.29.7)
model Friendship {
  id           String           @id @default(cuid())
  userA        String
  userB        String
  status       FriendshipStatus @default(pending)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  userAProfile User             @relation("UserA", fields: [userA], references: [id], onDelete: Cascade)
  userBProfile User             @relation("UserB", fields: [userB], references: [id], onDelete: Cascade)

  @@unique([userA, userB])
  @@index([userA, status])
  @@index([userB, status])
  @@map("friendships")
}

model SocialDuel {
  id            String        @id @default(cuid())
  challengerId  String
  opponentId    String
  status        DuelStatus    @default(pending)
  challengeType ChallengeType
  rewardXP      Int           @default(0)
  winnerId      String?
  createdAt     DateTime      @default(now())
  challenger    User          @relation("Challenger", fields: [challengerId], references: [id], onDelete: Cascade)
  opponent      User          @relation("Opponent", fields: [opponentId], references: [id], onDelete: Cascade)
  winner        User?         @relation("Winner", fields: [winnerId], references: [id], onDelete: SetNull)

  @@index([challengerId, status])
  @@index([opponentId, status])
  @@index([status])
  @@map("social_duels")
}

model SharedMission {
  id           String              @id @default(cuid())
  missionKey   String
  participants String[] // Array of user IDs
  status       SharedMissionStatus @default(active)
  rewardXP     Int                 @default(0)
  createdAt    DateTime            @default(now())
  completedAt  DateTime?

  @@index([status])
  @@index([missionKey])
  @@map("shared_missions")
}

// Economy system (v0.29.8)
model Currency {
  id           String        @id @default(cuid())
  key          String        @unique
  name         String
  symbol       String
  exchangeRate Float         @default(1.0) // Relative to base currency (gold)
  isPremium    Boolean       @default(false)
  createdAt    DateTime      @default(now())
  LedgerEntry  LedgerEntry[]

  @@index([key])
  @@map("currencies")
}

model UserWallet {
  id          String   @id @default(cuid())
  userId      String
  currencyKey String
  balance     Decimal  @default(0)
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, currencyKey])
  @@index([userId])
  @@index([currencyKey])
  @@map("user_wallets")
}

model MarketItem {
  id          String       @id @default(cuid())
  name        String
  description String       @db.Text
  price       Decimal
  currencyKey String
  rarity      String? // e.g., "common", "rare", "epic"
  category    ItemCategory
  stock       Int? // Optional stock tracking (null = unlimited)
  isEventItem Boolean      @default(false)
  createdAt   DateTime     @default(now())

  @@index([category])
  @@index([rarity])
  @@index([isEventItem])
  @@index([currencyKey])
  @@map("market_items")
}

model Transaction {
  id          String          @id @default(cuid())
  userId      String
  itemId      String? // Optional reference to MarketItem
  type        TransactionType
  amount      Decimal
  currencyKey String
  note        String?         @db.Text
  createdAt   DateTime        @default(now())
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([itemId])
  @@index([type])
  @@index([currencyKey])
  @@map("transactions")
}

// v0.32.2 - Admin Balance Tools: Dynamic economy multipliers
model BalanceSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Float
  updatedAt DateTime @updatedAt

  @@index([key])
  @@map("balance_settings")
}

// v0.32.3 - Economy Preset Profiles: Saved economy configurations
model EconomyPreset {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  modifiers   Json // Key-value pairs matching balance_settings keys
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@map("economy_presets")
}

// v0.33.0 - Alert System: System health alerts with auto-recovery
model SystemAlert {
  id           String            @id @default(cuid())
  type         SystemAlertType
  level        SystemAlertLevel
  message      String            @db.Text
  metadata     Json?
  createdAt    DateTime          @default(now())
  resolvedAt   DateTime?
  autoResolved Boolean           @default(false)

  @@index([createdAt(sort: Desc)])
  @@index([level])
  @@index([type])
  @@index([resolvedAt])
  @@map("system_alerts")
}

enum SystemAlertType {
  cron
  api
  db
  cache
  memory
  cpu
}

enum SystemAlertLevel {
  info
  warn
  error
  critical
}

// v0.33.1 - Alert Notifications: Webhook integrations for alerts
model AlertWebhook {
  id        String          @id @default(cuid())
  name      String
  url       String
  isActive  Boolean         @default(true)
  type      WebhookType
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([isActive])
  @@map("alert_webhooks")
}

enum WebhookType {
  discord
  slack
  generic
}

// v0.29.9 - Meta-Progression: Season model for seasonal cycles
model MetaSeason {
  id              String           @id @default(cuid())
  key             String           @unique
  title           String
  description String?
  region          String?
  startDate       DateTime
  endDate         DateTime?
  isActive        Boolean          @default(false)
  createdAt       DateTime         @default(now())
  prestigeRecords PrestigeRecord[]

  @@index([isActive])
  @@index([startDate])
  @@map("meta_seasons")
}

// v0.29.9 - Meta-Progression: Prestige records
model PrestigeRecord {
  id                 String     @id @default(cuid())
  userId             String
  seasonId           String
  oldLevel           Int
  legacyXP           Int        @default(0)
  prestigeCount      Int        @default(1)
  rewardBadgeId      String?
  prestigeTitle      String? // v0.29.14 - Title awarded at this prestige
  prestigeBadgeId    String? // v0.29.14 - Badge awarded at this prestige
  prestigeColorTheme String? // v0.29.14 - Color theme awarded at this prestige
  createdAt          DateTime   @default(now())
  user               User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  season             MetaSeason @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([seasonId])
  @@index([createdAt])
  @@map("prestige_records")
}

enum QuestionType {
  SINGLE_CHOICE
  MULTI_CHOICE
  RANGE
  NUMBER
  TEXT
}

enum UserRole {
  USER
  ADMIN
  MOD
  DEVOPS
}

enum TaskStatus {
  NEW
  ROUTED
  IN_PROGRESS
  DONE
  BLOCKED
}

enum TaskSource {
  WEB
  EMAIL
  API
}

enum AssigneeType {
  AUTO
  VA
}

enum AuthorType {
  USER
  VA
  SYSTEM
}

enum WorkflowTrigger {
  KEYWORD
  FORM
  API
}

enum WorkflowAction {
  GOOGLE_SEARCH
  WEB_SCRAPE
  DOC_SUMMARY
  CUSTOM
}

enum RunStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

enum IntegrationType {
  GMAIL
  SLACK
  WEBHOOK
}

enum QuestionSource {
  ai
  user
  import
}

// Tag type for humor/tone vs content sensitivity
enum TagType {
  tone
  content
}

// Cached hourly trending scores per region/scope
model TrendingQuestion {
  id           String   @id @default(cuid())
  questionId   String
  region       String   @default("global")
  windowStart  DateTime
  windowEnd    DateTime
  reactions24h Int      @default(0)
  score        Float    @default(0)
  updatedAt    DateTime @updatedAt

  question Question @relation(fields: [questionId], references: [id])

  @@unique([questionId, region])
  @@index([region, score])
  @@index([windowEnd])
  @@map("trending_questions")
}

enum CurrencyType {
  FUNDS
  DIAMONDS
}

enum LedgerKind {
  CREDIT
  DEBIT
}

enum ProductKind {
  CURRENCY_PACK
  COSMETIC
}

enum PurchaseStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum BatchStatus {
  PENDING
  RUNNING
  DONE
  FAILED
  PAUSED
}

enum JobStatus {
  PENDING
  RUNNING
  DONE
  FAILED
}

enum SubmissionType {
  QUESTION
  PACK
  EVENT
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
  FLAGGED
}

enum EventType {
  CHALLENGE
  THEMED_WEEK
  SPOTLIGHT
  COMMUNITY
}

enum EventStatus {
  DRAFT
  ACTIVE
  UPCOMING
  ENDED
  CANCELLED
}

enum VoteType {
  UPVOTE
  DOWNVOTE
}

enum SeasonStatus {
  UPCOMING
  ACTIVE
  ENDED
  ARCHIVED
}

enum CosmeticType {
  ICON
  TITLE
  BACKGROUND
  BADGE
  FRAME
}

enum CosmeticRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum SeasonalEventStatus {
  INACTIVE
  ACTIVE
  ENDED
}



// ========================================
// SKILLS & ABILITIES (v0.36.33)
// ========================================

model Skill {
  id          String   @id @default(cuid())
  name        String
  type String?    // 'active' | 'passive'
  description String
  power       Int       // base magnitude of skill
  cooldown    Int?      // only for active skills
  icon        String?
  scaling     Json?     // { "perLevel": 1.2 } MVP optional
  userSkills  UserSkill[]

  @@map("skills")
}

model UserSkill {
  id          String   @id @default(cuid())
  userId      String
  skillId     String
  level       Int       @default(1)
  equipped    Boolean   @default(false)
  cooldownRemaining Int @default(0) // Current cooldown counter
  user        User     @relation("UserSkills", fields: [userId], references: [id], onDelete: Cascade)
  skill       Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, equipped])
  @@map("user_skills")
}
// ========================================
// COMPANIONS & PETS (v0.36.32)
// ========================================

model Pet {
  id            String   @id @default(cuid())
  name          String
  type String?     // "pet" | "companion"
  rarity        String     // common/rare/epic/legendary
  bonus         Json?      // { "attack":1, "luck":2 } MVP: optional
  icon          String?    // svg or asset reference
  description String?
  region          String?
  userPets      UserPet[]

  @@map("pets")
}

model UserPet {
  id            String   @id @default(cuid())
  userId        String
  petId         String
  level         Int       @default(1)
  xp            Int       @default(0)
  equipped      Boolean   @default(false)
  nickname      String?   // user custom name
  createdAt     DateTime  @default(now())
  user          User      @relation("UserPets", fields: [userId], references: [id], onDelete: Cascade)
  pet           Pet       @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([userId, equipped])
  @@index([userId])
  @@index([petId])
  @@map("user_pets")
}
// ========================================
// COMBAT SYSTEM (v0.25.0 - Phase J-Lite)
// ========================================

model CombatSession {
  id            String   @id @default(cuid())
  userId        String
  heroHp        Int      @default(100)
  heroMaxHp     Int      @default(100)
  enemyHp       Int      @default(100)
  enemyMaxHp    Int      @default(100)
  enemyName     String   @default("Shadow")
  enemyType String?   @default("shadow") // "shadow", "clone", "nightmare", etc.
  xpGained      Int      @default(0)
  goldGained    Int      @default(0)
  kills         Int      @default(0)
  currentStreak Int      @default(0)
  isActive      Boolean  @default(true)
  lastActionAt  DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([lastActionAt])
  @@map("combat_sessions")
}


// ========================================
// FIGHT SYSTEM (v0.36.0 - Full Fighting System MVP)
// ========================================

model Enemy {
  id          String   @id @default(cuid())
  name        String
  level       Int
  power       Int      // flat attack
  defense     Int
  maxHp       Int
  rarity      String   @default("common") // common | elite | boss
  lootTable   Json     // { common:[itemId], rare:[...], gold:{min,max} }
  icon        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  fights      Fight[]

  @@index([rarity])
  @@index([level])
  @@map("enemies")
}



// ========================================
// PUBLIC COMPARISONS FEED (v0.26.15 - Phase K)
// ========================================

model PublicComparison {
  id             String   @id @default(cuid())
  question       String
  answers        String[]
  isPublic       Boolean  @default(true)
  reactionsLike  Int      @default(0)
  reactionsLaugh Int      @default(0)
  reactionsThink Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([isPublic, createdAt(sort: Desc)])
  @@map("public_comparisons")
}

enum ReflectionType {
  DAILY
  WEEKLY
  MONTHLY
  MILESTONE
}

enum UserVisibility {
  PUBLIC
  FRIENDS
  PRIVATE
}

enum NotificationType {
  REFLECTION
  LIKE
  COMMENT
  SYSTEM
}

// Localization enums (v0.27.0 - Phase M)
enum Lang {
  en
  cs
}

enum UserSynchTestStatus {
  pending
  completed
  expired
}

enum FactionBuffType {
  xp
  gold
  luck
  karma
  custom
}

enum RegionScope {
  global
  regional
}

enum CreationType {
  question
  mission
  item
  other
}

enum CreationStatus {
  pending
  approved
  rejected
}

enum PostcardStatus {
  pending
  delivered
  read
  deleted
}

enum ForkRarity {
  common
  rare
  special
}

enum ForkChoice {
  A
  B
}

enum DuetRunType {
  reflect
  collect
  challenge
}

enum DuetRunStatus {
  pending
  active
  completed
  expired
}

enum RitualTimeOfDay {
  morning
  evening
  any
}

enum MicroClanBuffType {
  xp
  gold
  karma
  compare
  reflect
}

enum LootTrigger {
  reflection
  mission
  comparison
  levelup
  random
}

enum LootRewardType {
  xp
  gold
  item
  cosmetic
  emote
}

enum LootRarity {
  common
  rare
  epic
  legendary
}

// Badge system enums (v0.29.0)
enum BadgeRarity {
  common
  rare
  epic
  legendary
  mythic
  eternal
}

enum BadgeUnlockType {
  level
  event
  season
  special
}

enum BadgeRewardType {
  currency
  item
  title
}

// Chronicle system enums (v0.29.1)
enum ChronicleType {
  weekly
  seasonal
}

// Region system enums (v0.29.3)
enum RegionBuffType {
  xp
  gold
  mood
  reflection
}

enum UnlockRequirementType {
  level
  task
  gold
  achievement
}

// Quest system enums (v0.29.4)
enum QuestType {
  daily
  weekly
  story
  side
}

enum QuestRequirementType {
  xp
  reflections
  gold
  missions
  custom
}

// Lore system enums (v0.29.5)
enum LoreSourceType {
  reflection
  quest
  item
  event
  system
}

enum LoreTone {
  serious
  comedic
  poetic
}

// Social system enums (v0.29.7)
enum FriendshipStatus {
  pending
  accepted
  blocked
}

enum DuelStatus {
  pending
  active
  completed
  expired
}

enum ChallengeType {
  xp
  reflection
  random
  poll
}

enum SharedMissionStatus {
  active
  completed
  expired
}

// Economy system enums (v0.29.8)
enum ItemCategory {
  item
  cosmetic
  booster
}

enum TransactionType {
  purchase
  reward
  gift
  refund
}

// Cron system enum (v0.29.21)
enum CronJobStatus {
  success
  error
}

// Activity type enum (v0.29.22)
enum ActivityType {
  reflection
  question
  quest
  badge
  achievement
  social
  system
  other
}

// NPC system enums (v0.29.23)
enum ArchetypeAffinity {
  thinker
  trickster
  guardian
  wanderer
  chaos
}

enum NPCTone {
  serious
  sarcastic
  poetic
  neutral
}

enum DialogueRarity {
  common
  rare
  epic
}

enum DialogueTriggerType {
  greeting
  quest
  reflection
  event
  random
}

// Question system enums (v0.29.24)
enum QuestionTemplateCategory {
  daily
  weekly
  archetype
  event
  wildcard
}

enum QuestionTone {
  serious
  poetic
  chaotic
  funny
}

// Battle Achievement system enums (v0.29.25)
enum BattleAchievementTriggerType {
  duelWin
  duelLose
  missionComplete
  event
}


// ========================================
// COMMUNITY FEED (v0.36.25 - Community Feed 1.0)
// ========================================

model FeedPost {
  id          String         @id @default(cuid())
  userId      String
  type String?         // 'achievement' | 'fight' | 'question' | 'levelup' | 'loot' | 'status' | 'milestone'
  content     String?        // optional text
  refId       String?        // fightId, achievementId, itemId, etc
  createdAt   DateTime       @default(now())
  visibility  String         @default("public") // future use
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments    FeedComment[]
  reactions   FeedReaction[]

  @@index([createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([type, createdAt(sort: Desc)])
  @@map("feed_posts")
}

model FeedComment {
  id        String    @id @default(cuid())
  postId    String
  userId    String
  content   String
  createdAt DateTime  @default(now())
  post      FeedPost  @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt(sort: Desc)])
  @@index([userId])
  @@map("feed_comments")
}

model FeedReaction {
  id        String    @id @default(cuid())
  postId    String
  userId    String
  emoji     String    // '👍', '🔥', '❤️', '💡'
  createdAt DateTime  @default(now())
  post      FeedPost  @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId, emoji])
  @@index([postId])
  @@index([userId])
  @@map("feed_reactions")
}

// ========================================
// SOCIAL COMPARE FEED 2.0 (v0.36.31)
// ========================================






// ========================================
// SOCIAL COMPARE FEED 2.0 (v0.36.31)
// ========================================

model ComparePost {
  id            String   @id @default(cuid())
  userId        String
  questionId    String?
  content       String?
  value         Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  visibility    String   @default("public")
  user          User     @relation("ComparePosts", fields: [userId], references: [id], onDelete: Cascade)
  reactions     CompareReaction[]
  comments      CompareComment[]

  @@index([createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([questionId])
  @@map("compare_posts")
}

model CompareReaction {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  type String?
  createdAt DateTime @default(now())
  post      ComparePost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User        @relation("CompareReactions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId, type])
  @@index([postId, createdAt(sort: Desc)])
  @@index([postId, userId])
  @@map("compare_reactions")
}

model CompareComment {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  post      ComparePost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User        @relation("CompareComments", fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt(sort: Desc)])
  @@index([userId])
  @@map("compare_comments")
}





// ========================================
// NOTIFICATIONS (v0.36.26 - Notifications 2.0)
// ========================================

model Notification {
  id          String   @id @default(cuid())
  userId      String
  type String?   // 'achievement' | 'fight' | 'quest' | 'system' | 'loot' | 'levelup' | 'social'
  title       String
  body        String?
  refId       String?
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, isRead, createdAt(sort: Desc)])
  @@map("notifications")
}


enum BattleAchievementRarity {
  common
  rare
  epic
  legendary
}

// Global Mood system enums (v0.29.26)
enum GlobalMoodType {
  calm
  chaos
  neutral
}

// Note: Materialized views (leaderboard_view) are not directly supported in Prisma
// Create via raw SQL migration in /packages/db/migrations/
// Example: CREATE MATERIALIZED VIEW leaderboard_view AS ...

